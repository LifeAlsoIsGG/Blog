<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | Draco&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <script src="https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <link rel="icon" href="/favicon.ico">
    <link rel="icon" href="/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512">
    <link rel="icon" href="/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192">
    <link rel="icon" href="/assets/icon/chrome-512.png" type="image/png" sizes="512x512">
    <link rel="icon" href="/assets/icon/chrome-192.png" type="image/png" sizes="192x192">
    <link rel="manifest" href="/manifest.webmanifest" crossorigin="use-credentials">
    <link rel="apple-touch-icon" href="/assets/icon/apple-icon-152.png">
    <meta name="description" content="美丽新世界">
    <meta property="og:url" content="https://vuepress-theme-hope-demo.mrhope.site/mq/rabbitmq/RabbitMQ.html">
    <meta property="og:site_name" content="Draco&#39;s Blog">
    <meta property="og:title" content="RabbitMQ">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta property="og:locale:alternate" content="zh-CN">
    <meta property="article:author" content="Draco">
    <meta property="article:tag" content="消息队列">
    <meta property="article:published_time" content="2021-08-13T00:04:05.000Z">
    <meta name="theme-color" content="#46bd87">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/assets/icon/ms-icon-144.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/assets/css/0.styles.66747f18.css" as="style"><link rel="preload" href="/assets/js/app.daa8f6a5.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Layout.df1685e0.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.9dd70d26.js" as="script"><link rel="preload" href="/assets/js/page-RabbitMQ.50dfe249.js" as="script"><link rel="preload" href="/assets/js/vendors~layout-Blog~layout-Layout.2ab8e312.js" as="script"><link rel="prefetch" href="/assets/js/125.8131a161.js"><link rel="prefetch" href="/assets/js/126.79d1f1dd.js"><link rel="prefetch" href="/assets/js/127.ab777c20.js"><link rel="prefetch" href="/assets/js/128.288d6e2a.js"><link rel="prefetch" href="/assets/js/129.23d295cf.js"><link rel="prefetch" href="/assets/js/130.ad1e9759.js"><link rel="prefetch" href="/assets/js/131.4e46fb61.js"><link rel="prefetch" href="/assets/js/layout-Blog.15024dbf.js"><link rel="prefetch" href="/assets/js/layout-Layout.e7c6637c.js"><link rel="prefetch" href="/assets/js/layout-NotFound.1ff18383.js"><link rel="prefetch" href="/assets/js/layout-Slide.469c1fb5.js"><link rel="prefetch" href="/assets/js/page-About.2eba257c.js"><link rel="prefetch" href="/assets/js/page-BlogHome.947c3eaa.js"><link rel="prefetch" href="/assets/js/page-Componentdisabled.62818d0f.js"><link rel="prefetch" href="/assets/js/page-DockerInstallsoftware.b7cefabf.js"><link rel="prefetch" href="/assets/js/page-Dockerdeployment.178715e4.js"><link rel="prefetch" href="/assets/js/page-Docker学习笔记.10666261.js"><link rel="prefetch" href="/assets/js/page-Dubbo笔记.1bbe6c77.js"><link rel="prefetch" href="/assets/js/page-EasyExcel导入导出Excel.a6b373cc.js"><link rel="prefetch" href="/assets/js/page-ElasticSearch笔记.b11479f9.js"><link rel="prefetch" href="/assets/js/page-ElasticSearch面试.c07ec91b.js"><link rel="prefetch" href="/assets/js/page-Encryptionarticle.27a932f7.js"><link rel="prefetch" href="/assets/js/page-Git笔记.eda5390d.js"><link rel="prefetch" href="/assets/js/page-Golang-介绍和使用.ad44e7de.js"><link rel="prefetch" href="/assets/js/page-Golang-语法基础.a9358b44.js"><link rel="prefetch" href="/assets/js/page-GoogleCloudSpanner.43b4ad6e.js"><link rel="prefetch" href="/assets/js/page-Guides.7cb8ee35.js"><link rel="prefetch" href="/assets/js/page-Hadoop伪分布式配置.9d528440.js"><link rel="prefetch" href="/assets/js/page-HttpServletrequest与HttpServletResponse.987522c9.js"><link rel="prefetch" href="/assets/js/page-IDEA初始化SpringBoot项目+逆向工程+配置.d468c0d3.js"><link rel="prefetch" href="/assets/js/page-JVM-类加载子系统.7b1d61c9.js"><link rel="prefetch" href="/assets/js/page-JVM-运行时数据区.511a5902.js"><link rel="prefetch" href="/assets/js/page-JVM.8a56fec7.js"><link rel="prefetch" href="/assets/js/page-JWT认证原理(更新中).dbcb6d9d.js"><link rel="prefetch" href="/assets/js/page-Java-IO.0cc7ad9e.js"><link rel="prefetch" href="/assets/js/page-Java-String.1cc1ec73.js"><link rel="prefetch" href="/assets/js/page-Java-UML类图.840ae621.js"><link rel="prefetch" href="/assets/js/page-Java-基础知识笔记.e28e3633.js"><link rel="prefetch" href="/assets/js/page-Java-基础面试题.a231dadc.js"><link rel="prefetch" href="/assets/js/page-Java-多线程并发.62e442d9.js"><link rel="prefetch" href="/assets/js/page-Java-常用方法汇总.179f289c.js"><link rel="prefetch" href="/assets/js/page-Java-新特性.771be546.js"><link rel="prefetch" href="/assets/js/page-Java-注解和反射.6ef2d074.js"><link rel="prefetch" href="/assets/js/page-Java-设计模式.2546a518.js"><link rel="prefetch" href="/assets/js/page-Java-集合容器.43c0c0ae.js"><link rel="prefetch" href="/assets/js/page-JavaScript面试题.4c2e59d4.js"><link rel="prefetch" href="/assets/js/page-JavaSwing-超市系统.7ecc417f.js"><link rel="prefetch" href="/assets/js/page-Javaweb大学活动管理系统.2c004c1b.js"><link rel="prefetch" href="/assets/js/page-Java多线程-1.c7330928.js"><link rel="prefetch" href="/assets/js/page-Java多线程-2.f60ee83f.js"><link rel="prefetch" href="/assets/js/page-Java多线程-JUC使用.33a829d8.js"><link rel="prefetch" href="/assets/js/page-Java多线程-关键字锁.c96985d5.js"><link rel="prefetch" href="/assets/js/page-Java学习目录.831c435c.js"><link rel="prefetch" href="/assets/js/page-Java面试整理.e431a384.js"><link rel="prefetch" href="/assets/js/page-Linux常用命令.f7475474.js"><link rel="prefetch" href="/assets/js/page-Linux技巧.5d92d846.js"><link rel="prefetch" href="/assets/js/page-MarkdownEnhance.74675d79.js"><link rel="prefetch" href="/assets/js/page-Markdown增强.97200da1.js"><link rel="prefetch" href="/assets/js/page-Maven笔记.e8bd2d5f.js"><link rel="prefetch" href="/assets/js/page-MyProject.d86ced6f.js"><link rel="prefetch" href="/assets/js/page-Mybatis-Plus基础笔记.e7e02299.js"><link rel="prefetch" href="/assets/js/page-Mybatis基础笔记.cbcf5179.js"><link rel="prefetch" href="/assets/js/page-Mybatis语法笔记.5abd9474.js"><link rel="prefetch" href="/assets/js/page-Mybatis逆向工程Example类使用.715fecd1.js"><link rel="prefetch" href="/assets/js/page-Mysql理论学习笔记.896cd9ba.js"><link rel="prefetch" href="/assets/js/page-Nginx-动静分离.ab899ff6.js"><link rel="prefetch" href="/assets/js/page-Nginx-反向代理.a992685d.js"><link rel="prefetch" href="/assets/js/page-Nginx-负载均衡.84beeda6.js"><link rel="prefetch" href="/assets/js/page-Nginx基础笔记和安装配置.ef8bdca2.js"><link rel="prefetch" href="/assets/js/page-Nginx学习目录.3eb23960.js"><link rel="prefetch" href="/assets/js/page-Promise异步调用.d04ebda2.js"><link rel="prefetch" href="/assets/js/page-RabbitMQ面试题.5a1346ce.js"><link rel="prefetch" href="/assets/js/page-Redis应用场景.3f1ff728.js"><link rel="prefetch" href="/assets/js/page-Redis理论学习笔记.7cea7686.js"><link rel="prefetch" href="/assets/js/page-Redis部署与基本使用.ebeabc90.js"><link rel="prefetch" href="/assets/js/page-Redis集群和哨兵.e1a63bd1.js"><link rel="prefetch" href="/assets/js/page-SQL学习笔记.fde2dea2.js"><link rel="prefetch" href="/assets/js/page-SSH.8a33bed2.js"><link rel="prefetch" href="/assets/js/page-Slidepage.6b5a227e.js"><link rel="prefetch" href="/assets/js/page-Spring-RestTemplate.5861ab3e.js"><link rel="prefetch" href="/assets/js/page-SpringBootVue项目搭建(持续更新).e47d408a.js"><link rel="prefetch" href="/assets/js/page-SpringSecurity.c6eae605.js"><link rel="prefetch" href="/assets/js/page-Spring基础笔记.ab4f8b4f.js"><link rel="prefetch" href="/assets/js/page-Spring注解.c29b96f0.js"><link rel="prefetch" href="/assets/js/page-Spring错误坑记录.f7f3a71f.js"><link rel="prefetch" href="/assets/js/page-Spring错误笔记.6f64e83b.js"><link rel="prefetch" href="/assets/js/page-Spring面试题.14e48b86.js"><link rel="prefetch" href="/assets/js/page-Swagger使用.b0ebbac0.js"><link rel="prefetch" href="/assets/js/page-pageconfig.36744f88.js"><link rel="prefetch" href="/assets/js/page-主要功能与配置演示.90dc3c8d.js"><link rel="prefetch" href="/assets/js/page-修改Host以访问Github.74163b42.js"><link rel="prefetch" href="/assets/js/page-前端学习目录.588bdcb3.js"><link rel="prefetch" href="/assets/js/page-字节测开面经.f3bc3e25.js"><link rel="prefetch" href="/assets/js/page-学习路线.a814f0d8.js"><link rel="prefetch" href="/assets/js/page-实验室出入管理小程序.8ffdf958.js"><link rel="prefetch" href="/assets/js/page-密码加密的文章.c5ec864b.js"><link rel="prefetch" href="/assets/js/page-幻灯片页.944ec447.js"><link rel="prefetch" href="/assets/js/page-操作系统.2cb64f1e.js"><link rel="prefetch" href="/assets/js/page-数据库学习目录.9f00f7dc.js"><link rel="prefetch" href="/assets/js/page-数据结构.53cfa286.js"><link rel="prefetch" href="/assets/js/page-数据结构算法学习目录.58edbfcf.js"><link rel="prefetch" href="/assets/js/page-数据结构算法题目合集.a3bed156.js"><link rel="prefetch" href="/assets/js/page-服务器上部署SpringBoot.b88860ec.js"><link rel="prefetch" href="/assets/js/page-概述参考.206b5851.js"><link rel="prefetch" href="/assets/js/page-算法.f77e5555.js"><link rel="prefetch" href="/assets/js/page-组件禁用.0eb89b16.js"><link rel="prefetch" href="/assets/js/page-腾讯云学习笔记.1ec350be.js"><link rel="prefetch" href="/assets/js/page-自定义布局.27ab6602.js"><link rel="prefetch" href="/assets/js/page-计算机知识.ec8894bd.js"><link rel="prefetch" href="/assets/js/page-计算机网络.91b67f6f.js"><link rel="prefetch" href="/assets/js/page-认识SpringCloud.5f7b1059.js"><link rel="prefetch" href="/assets/js/page-设计模式七大原则.1ebf6c77.js"><link rel="prefetch" href="/assets/js/page-设计模式之J2EE设计模式.b018e36f.js"><link rel="prefetch" href="/assets/js/page-设计模式之创建型设计模式.76e32733.js"><link rel="prefetch" href="/assets/js/page-设计模式之结构型设计模式.ef490b42.js"><link rel="prefetch" href="/assets/js/page-设计模式之行为型设计模式.b9dbbcf8.js"><link rel="prefetch" href="/assets/js/page-面试大纲.d37d9455.js"><link rel="prefetch" href="/assets/js/page-音频批量识别平台.ae7e7376.js"><link rel="prefetch" href="/assets/js/page-页面配置.44fe4e14.js"><link rel="prefetch" href="/assets/js/page-项目主页.e4d20766.js"><link rel="prefetch" href="/assets/js/vendors~chart.1269e3a3.js"><link rel="prefetch" href="/assets/js/vendors~flowchart.68e9675e.js"><link rel="prefetch" href="/assets/js/vendors~mermaid.e827c069.js"><link rel="prefetch" href="/assets/js/vendors~photo-swipe.77c79458.js"><link rel="prefetch" href="/assets/js/vendors~reveal.de804941.js"><link rel="prefetch" href="/assets/js/vendors~waline.43334e0c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.66747f18.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><!----> <div class="content__navbar-start"></div> <button title="Sidebar Button" class="sidebar-button"><span class="icon"></span></button> <a href="/" class="home-link router-link-active"><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/avatar.png" alt="Draco's Blog" class="logo"> <!----> <span class="site-name can-hide">Draco's Blog</span></a> <!----> <div class="content__navbar-center"></div> <div class="links"><button tabindex="-1" aria-hidden="true" class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><span class="default-theme"></span></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0 0 42.667-42.667V128a42.667 42.667 0 0 0-85.334 0v85.333A42.667 42.667 0 0 0 512 256zm384 213.333h-85.333a42.667 42.667 0 0 0 0 85.334H896a42.667 42.667 0 0 0 0-85.334zM256 512a42.667 42.667 0 0 0-42.667-42.667H128a42.667 42.667 0 0 0 0 85.334h85.333A42.667 42.667 0 0 0 256 512zm9.387-298.667a42.667 42.667 0 0 0-59.307 62.72l61.44 59.307a42.667 42.667 0 0 0 31.147 11.947 42.667 42.667 0 0 0 30.72-13.227 42.667 42.667 0 0 0 0-60.16zm459.946 133.974a42.667 42.667 0 0 0 29.44-11.947l61.44-59.307a42.667 42.667 0 0 0-57.6-62.72l-61.44 60.587a42.667 42.667 0 0 0 0 60.16 42.667 42.667 0 0 0 28.16 13.227zM512 768a42.667 42.667 0 0 0-42.667 42.667V896a42.667 42.667 0 0 0 85.334 0v-85.333A42.667 42.667 0 0 0 512 768zm244.48-79.36a42.667 42.667 0 0 0-59.307 61.44l61.44 60.587a42.667 42.667 0 0 0 29.44 11.946 42.667 42.667 0 0 0 30.72-12.8 42.667 42.667 0 0 0 0-60.586zm-488.96 0-61.44 59.307a42.667 42.667 0 0 0 0 60.586 42.667 42.667 0 0 0 30.72 12.8 42.667 42.667 0 0 0 28.587-10.666l61.44-59.307a42.667 42.667 0 0 0-59.307-61.44zM512 341.333A170.667 170.667 0 1 0 682.667 512 170.667 170.667 0 0 0 512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 0 0-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 0 0-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/category/" class="nav-link"><i class="iconfont icon-note"></i>
  Category
</a></div><div class="nav-item"><a href="/project/" class="nav-link"><i class="iconfont icon-note"></i>
  My Project
</a></div><div class="nav-item"><a href="/guide/" class="nav-link"><i class="iconfont icon-creative"></i>
  Guide
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont icon-info"></i>
  About
</a></div></nav> <div class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon i18n-icon" style="width:1rem;height:1rem;vertical-align:middle;margin-left:1rem;"><path d="M639.981 344.075c14.805 44.45 34.542 79.023 69.084 113.596 29.603-29.634 49.34-69.146 64.145-113.596H639.981zM314.33 591.024h128.29l-64.145-172.865-64.145 172.865z" fill="currentColor"></path> <path d="M807.746 116.882H215.643c-54.274 0-98.681 44.45-98.681 98.78v592.677c0 54.329 44.407 98.78 98.68 98.78h592.104c54.273 0 98.681-44.451 98.681-98.78V215.66c0-54.329-39.475-98.78-98.68-98.78zM565.971 754.01c-9.866 9.878-19.738 9.878-29.603 9.878-4.94 0-14.805 0-19.738-4.939-4.939-4.939-9.872 0-9.872-4.939s-4.932-9.878-9.865-19.756c-4.94-9.878-4.94-14.817-9.872-24.695L467.29 655.23H294.592l-19.737 54.33c-9.866 19.755-14.805 34.572-19.738 44.45-4.939 9.878-14.804 9.878-29.603 9.878-9.871 0-19.737-4.939-29.609-9.878-9.865-9.878-14.798-14.817-14.798-24.695 0-4.939 0-9.878 4.933-19.756 4.939-9.878 4.939-14.817 9.865-24.695l108.553-276.583c4.939-9.878 4.939-19.756 9.872-29.633 4.932-9.878 9.865-19.756 14.798-24.695 4.939-4.94 9.872-14.817 19.737-19.756 9.872-4.94 19.738-4.94 29.61-4.94 9.865 0 19.73 0 29.603 4.94 9.865 4.939 14.804 9.878 19.737 19.756 4.933 4.939 9.866 14.817 14.798 24.695 4.94 9.877 9.872 19.755 14.805 34.572l108.553 271.644c9.865 19.756 14.804 34.573 14.804 44.451-4.939 4.94-9.872 14.817-14.804 24.695zm271.378-192.62c-54.273-19.756-93.748-44.451-128.29-74.085-34.536 34.573-78.943 59.268-133.223 74.085l-14.798-24.695c54.273-14.817 98.68-34.573 133.223-69.146-34.542-34.573-64.145-79.024-74.017-128.413h-49.34V319.38h133.228c-9.877-14.817-19.743-34.573-29.609-49.39l14.799-4.94c9.871 14.818 24.676 34.574 34.542 54.33h123.35v24.695h-49.34c-14.798 49.39-39.468 93.84-69.077 123.474 34.541 29.634 74.01 54.329 128.29 69.146l-19.738 24.695z" fill="currentColor"></path></svg> <span class="arrow"></span></button> <ul class="nav-dropdown"><li class="dropdown-item"><a href="/mq/rabbitmq/RabbitMQ/" aria-current="page" class="nav-link router-link-exact-active router-link-active active"><!---->
  English
</a></li><li class="dropdown-item"><a href="/zh/" class="nav-link"><!---->
  简体中文
</a></li></ul></div></div></div> <a rel="noopener noreferrer" href="https://github.com/LifeAlsoIsGG" target="_blank" class="repo-link can-hide">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> <!----> <div class="content__navbar-end"></div></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><div vocab="https://schema.org/" typeof="Person" class="blogger-info mobile"><div data-balloon-pos="down" role="navigation" class="blogger hasIntro"><img property="image" alt="Blogger Avatar" src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/avatar.png" class="avatar round"> <div property="name" class="name">Draco</div> <meta property="url" content="/about/"></div> <div class="num-wrapper"><div><div class="num">110</div> <div>Articles</div></div> <div><div class="num">34</div> <div>Category</div></div> <div><div class="num">58</div> <div>Tags</div></div> <div><div class="num">110</div> <div>Timeline</div></div></div> <div class="media-links-wrapper"><a href="https://github.com/LifeAlsoIsGG" rel="noopener noreferrer" target="_blank" aria-label="Github" data-balloon-pos="up" class="media-link"><span class="sr-only">Github</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-github"><circle cx="512" cy="512" r="512" fill="#171515"></circle> <path d="M509.423 146.442c-200.317 0-362.756 162.42-362.756 362.8 0 160.266 103.936 296.24 248.109 344.217 18.139 3.327 24.76-7.872 24.76-17.486 0-8.613-.313-31.427-.49-61.702-100.912 21.923-122.205-48.63-122.205-48.63-16.495-41.91-40.28-53.067-40.28-53.067-32.937-22.51 2.492-22.053 2.492-22.053 36.407 2.566 55.568 37.386 55.568 37.386 32.362 55.438 84.907 39.43 105.58 30.143 3.296-23.444 12.667-39.43 23.032-48.498-80.557-9.156-165.246-40.28-165.246-179.297 0-39.604 14.135-71.988 37.342-97.348-3.731-9.178-16.18-46.063 3.556-96.009 0 0 30.46-9.754 99.76 37.19 28.937-8.048 59.97-12.071 90.823-12.211 30.807.14 61.843 4.165 90.822 12.21 69.26-46.944 99.663-37.189 99.663-37.189 19.792 49.946 7.34 86.831 3.61 96.01 23.25 25.359 37.29 57.742 37.29 97.347 0 139.366-84.82 170.033-165.637 179.013 13.026 11.2 24.628 33.342 24.628 67.182 0 48.498-.445 87.627-.445 99.521 0 9.702 6.535 20.988 24.945 17.444 144.03-48.067 247.881-183.95 247.881-344.175 0-200.378-162.442-362.798-362.802-362.798z" fill="#FFF"></path></svg></a><a href="https://twitter.com/LifeAlsoIsGG" rel="noopener noreferrer" target="_blank" aria-label="Twitter" data-balloon-pos="up" class="media-link"><span class="sr-only">Twitter</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-twitter"><circle cx="512" cy="512" r="512" fill="#5EAADE"></circle> <path d="M749.737 364.631c-17.594 7.805-36.513 13.088-56.371 15.459 20.269-12.148 35.836-31.387 43.156-54.312A196.233 196.233 0 0 1 674.2 349.6c-17.894-19.083-43.406-30.997-71.636-30.997-54.2 0-98.137 43.944-98.137 98.157 0 7.695.861 15.19 2.544 22.373-81.57-4.092-153.876-43.174-202.284-102.558-8.443 14.498-13.285 31.356-13.285 49.348 0 34.05 17.326 64.096 43.656 81.697a97.69 97.69 0 0 1-44.447-12.277c-.01.41-.01.82-.01 1.24 0 47.558 33.822 87.23 78.72 96.249a98.285 98.285 0 0 1-25.852 3.448 97.491 97.491 0 0 1-18.465-1.768c12.483 39.002 48.725 67.38 91.672 68.17-33.582 26.334-75.897 42.024-121.884 42.024-7.924 0-15.736-.46-23.408-1.37 43.434 27.844 95.014 44.104 150.443 44.104 180.505 0 279.221-149.576 279.221-279.294 0-4.263-.09-8.494-.278-12.708 19.178-13.835 35.813-31.115 48.967-50.807z" fill="#FFF"></path></svg></a><a href="http://localhost:8083/blog-vuepress/tencent:/AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1138312802.html" rel="noopener noreferrer" target="_blank" aria-label="QQ" data-balloon-pos="up" class="media-link"><span class="sr-only">QQ</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-qq"><circle cx="512" cy="512" r="512" fill="#5EAADE"></circle> <path d="M729.46 627.3c-3.157-39.628-24.045-83.747-32.624-105.91l-22.084-57.047c-.702-23.73 6.312-78.322-30.511-146.61s-110.82-74.446-124.497-75.147c-13.677-.701-99.248-1.403-141.331 72.945-42.084 74.347-30.745 148.812-30.745 148.812l-23.523 57.478c-.001.002-10.962 26.223-20.43 58.135-9.469 31.914-18.938 82.064-9.469 92.234 9.47 10.17 43.837-46.643 46.993-51.903 0 0 2.456 27.18 8.943 41.383l.81 1.776.33.723.38.826.3.652.444.96.203.436a281.465 281.465 0 0 0 1.917 4.025l.189.386c.231.473.468.953.711 1.442l.146.292c6.886 13.807 18.61 33.823 37.443 50.42l.018.016-1.184.387c-10.667 3.516-31.694 11.21-40.625 19.82-1.717 1.655-2.987 3.344-3.65 5.045-5.376 13.794 4.208 15.43 20.575 16.366 16.366.934 94.923 3.04 132.564-2.221.407-.056.787-.114 1.17-.171 2.711.094 5.324.142 7.83.16l.151.002c.836.005 1.663.008 2.475.008.496 0 1.015-.002 1.542-.006l.21-.001a222.593 222.593 0 0 0 5.462-.107c.26.038.508.076.778.114 37.642 5.26 116.198 3.156 132.564 2.22 16.366-.934 25.951-2.571 20.574-16.365-4.302-11.037-34.175-21.62-45.956-25.413a141.388 141.388 0 0 0 7.958-7.645l.237-.245a142.494 142.494 0 0 0 2.53-2.702c42.435-46.643 38.928-76.101 40.682-92.935 0 0 35.775 51.553 43.488 53.306 7.713 1.754 10.169-6.31 7.012-45.94z" fill="#FFF"></path></svg></a></div></div> <hr> <!----> <div class="content__sidebar-top"></div> <nav class="sidebar-nav-links"><div class="nav-item"><a href="/category/" class="nav-link"><i class="iconfont icon-note"></i>
  Category
</a></div><div class="nav-item"><a href="/project/" class="nav-link"><i class="iconfont icon-note"></i>
  My Project
</a></div><div class="nav-item"><a href="/guide/" class="nav-link"><i class="iconfont icon-creative"></i>
  Guide
</a></div><div class="nav-item"><a href="/about/" class="nav-link"><i class="iconfont icon-info"></i>
  About
</a></div> <a rel="noopener noreferrer" href="https://github.com/LifeAlsoIsGG" target="_blank" class="repo-link">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <!----> <div class="content__sidebar-center"></div> <ul class="sidebar-links"><li><a href="/study-line/" class="sidebar-link"><i class="iconfont icon-info"></i>学习路线</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">My Project</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Interview</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><i class="iconfont icon-code"></i> <span class="title">java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Golang</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Database</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Mybatis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">DataStructure</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">ElasticSearch</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Docker</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Nginx</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">MessageQueue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Computer Knowledge</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">ErrorNote</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Git</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Frontend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading clickable"><!----> <span class="title">Guide</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/about/" class="sidebar-link"><i class="iconfont icon-info"></i>About</a></li></ul> <!----> <div class="content__sidebar-bottom"></div> <!----></aside> <main class="page"><nav class="breadcrumb disable"><!----></nav> <!----> <div class="content__page-top"></div> <div vocab="https://schema.org/" typeof="Article" class="page-title"><h1><!----> <span property="headline">RabbitMQ</span></h1> <div class="page-info"><!----> <span aria-label="Author🖊" data-balloon-pos="down" categoryPath="/category/$category/" tagPath="/tag/$tag/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon author-icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z" fill="currentColor"></path></svg> <span property="author">Draco</span></span><span aria-label="Page views🔢" data-balloon-pos="down" defaultAuthor="Draco" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 0 0-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/mq/rabbitmq/RabbitMQ/" data-flag-title="RabbitMQ" class="leancloud_visitors waline-visitor-count"><span class="leancloud-visitors-count">...</span></span></span><span aria-label="Writing Date📅" data-balloon-pos="down" defaultAuthor="Draco" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="time-info"><svg viewBox="0 0 1030 1024" xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 0 1-33.473-33.473V143.657H180.6A134.314 134.314 0 0 0 46.66 277.595v535.756A134.314 134.314 0 0 0 180.6 947.289h669.74a134.36 134.36 0 0 0 133.94-133.938V277.595a134.314 134.314 0 0 0-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 0 1-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 0 1-33.472 33.473z" fill="currentColor"></path></svg> <span property="datePublished">2021-08-13 00:04:05</span></span><!----><span aria-label="Tags🏷" data-balloon-pos="down" defaultAuthor="Draco" categoryPath="/category/$category/"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon tag-icon"><path d="M939.902 458.563 910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 0 0 0 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z" fill="currentColor"></path></svg> <ul class="tags-wrapper"><li class="tag clickable tag0"><span role="navigation">消息队列</span></li><li class="tag clickable tag1"><span role="navigation">RabbitMQ</span></li></ul> <meta property="keywords" content="消息队列,RabbitMQ"></span><span aria-label="Reading Time⌛" data-balloon-pos="down" defaultAuthor="Draco" categoryPath="/category/$category/" tagPath="/tag/$tag/" class="reading-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon timer-icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z" fill="currentColor"></path></svg> <span>About 54 min</span> <meta property="timeRequired" content="PT54M"></span></div> <!----> <hr></div> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#大纲" class="anchor-link heading2"><div>大纲</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#参考" class="anchor-link heading2"><div>参考</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#什么是消息中间件" class="anchor-link heading2"><div>什么是消息中间件</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息中间件作用" class="anchor-link heading2"><div>消息中间件作用</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#rabbitmq特点" class="anchor-link heading2"><div>RabbitMQ特点</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#常用消息中间件" class="anchor-link heading2"><div>常用消息中间件</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#rabbitmq入门" class="anchor-link heading2"><div>RabbitMQ入门</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#介绍" class="anchor-link heading3"><div>介绍</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#核心概念" class="anchor-link heading3"><div>核心概念</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#交换器类型-路由规则" class="anchor-link heading3"><div>交换器类型（路由规则）</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#客户端开发向导" class="anchor-link heading2"><div>客户端开发向导</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#连接" class="anchor-link heading3"><div>连接</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#使用交换器和队列" class="anchor-link heading3"><div>使用交换器和队列</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#交换器声明方法属性" class="anchor-link heading3"><div>交换器声明方法属性</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#队列申明方法属性" class="anchor-link heading3"><div>队列申明方法属性</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#交换器队列绑定方法属性" class="anchor-link heading3"><div>交换器队列绑定方法属性</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#交换器与交换器绑定" class="anchor-link heading3"><div>交换器与交换器绑定</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#发送消息方法属性" class="anchor-link heading3"><div>发送消息方法属性</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消费消息" class="anchor-link heading3"><div>消费消息</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消费者端确认与拒绝autoack" class="anchor-link heading3"><div>消费者端确认与拒绝autoAck</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#关闭连接" class="anchor-link heading3"><div>关闭连接</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息何去何从-未路由消息处理" class="anchor-link heading2"><div>消息何去何从（未路由消息处理）</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#mandatory-immediate" class="anchor-link heading3"><div>mandatory&amp;immediate</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#mandatory" class="anchor-link heading3"><div>mandatory</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#immediate" class="anchor-link heading3"><div>immediate</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#备份交换机" class="anchor-link heading3"><div>备份交换机</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#过期时间-ttl" class="anchor-link heading2"><div>过期时间(TTL)</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#设置消息ttl" class="anchor-link heading3"><div>设置消息TTL</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#设置队列ttl" class="anchor-link heading3"><div>设置队列TTL</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#死信队列" class="anchor-link heading2"><div>死信队列</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息成为死信的情况" class="anchor-link heading3"><div>消息成为死信的情况</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#示例" class="anchor-link heading3"><div>示例</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#延迟队列" class="anchor-link heading2"><div>延迟队列</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#优先级队列" class="anchor-link heading2"><div>优先级队列</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#rpc实现" class="anchor-link heading2"><div>RPC实现</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#持久化" class="anchor-link heading2"><div>持久化</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#镜像队列" class="anchor-link heading3"><div>镜像队列</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#生产者确认" class="anchor-link heading2"><div>生产者确认</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#事务机制" class="anchor-link heading3"><div>事务机制</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#发送确认机制" class="anchor-link heading3"><div>发送确认机制</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#比较" class="anchor-link heading3"><div>比较</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消费端要点" class="anchor-link heading2"><div>消费端要点</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息分发" class="anchor-link heading3"><div>消息分发</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息顺序性" class="anchor-link heading3"><div>消息顺序性</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#弃用queueingconsumer" class="anchor-link heading3"><div>弃用QueueingConsumer</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#消息传输保障" class="anchor-link heading2"><div>消息传输保障</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#恰好一次" class="anchor-link heading3"><div>恰好一次</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#rabbitmq管理" class="anchor-link heading2"><div>RabbitMQ管理</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#多用户和权限" class="anchor-link heading3"><div>多用户和权限</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#用户管理" class="anchor-link heading3"><div>用户管理</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#web端管理" class="anchor-link heading3"><div>Web端管理</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#应用与集群" class="anchor-link heading2"><div>应用与集群</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#应用" class="anchor-link heading3"><div>应用</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#集群" class="anchor-link heading3"><div>集群</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#服务端状态" class="anchor-link heading3"><div>服务端状态</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#httpapi管理" class="anchor-link heading3"><div>HTTPAPI管理</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#rabbitmq配置" class="anchor-link heading2"><div>RabbitMQ配置</div></a></li><li class="anchor"><a href="/mq/rabbitmq/RabbitMQ/#环境变量" class="anchor-link heading3"><div>环境变量</div></a></li></ul></div></aside></div> <!----> <div class="content__content-top"></div> <div class="theme-default-content content__default"><h2 id="大纲"><a href="#大纲" class="header-anchor">#</a> 大纲</h2> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/RabbitMQ.png" alt="RabbitMQ大纲" loading="lazy"></p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><p><a href="https://www.rabbitmq.com/" target="_blank" rel="noopener noreferrer">RabbitMQ官方文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.rabbitmq.com/rabbitmqctl.8.html" target="_blank" rel="noopener noreferrer">rabbitmqctl文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>尚硅谷RabbitMQ</p></li> <li><p><a href="https://zhangc233.github.io/2021/07/23/RabbitMQ/" target="_blank" rel="noopener noreferrer">尚硅谷笔记<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>《RabbitMQ实战指南》</p></li></ul> <h2 id="什么是消息中间件"><a href="#什么是消息中间件" class="header-anchor">#</a> 什么是消息中间件</h2> <p>消息、（Message）是指在应用间传送的数据。消息可以非常简单，比如只包含文本字符串、JSON等，也可以很复杂，比如内嵌对象。</p> <p>消息队列中间件（Message Queue Middleware，简称为MQ）是指利用高效可靠的消息传递机制进行与平台无关的数据交流，并基于数据通信来进行分布式系统的集成。通过提供消息传递和消息排队模型，它可以在分布式环境下扩展进程间的通信。</p> <p>消息队列中间件，也可以称为消息队列或者消息中间件。它一般有两种传递模式：点对点（PP，Point-to-Point）模式和发布/订阅（Pub/Sub）模式。</p> <ul><li>点对点模式是基于队列的，消息生产者发送消息到队列，消息消费者从队列中接收消息，队列的存在使得消息的异步传输成为可能。</li> <li>发布订阅模式定义了如何向一个内容节点发布和订阅消息，这个内容节点称为主题（topic），主题可以认为是消息传递的中介，消息发布者将消息发布到某个主题，而消息订阅者则从主题中订阅消息。主题使得消息的订阅者与消息的发布者互相保持独立，不需要进行接触即可保证消息的传递，发布/订阅模式在消息的一对多广播时采用。</li></ul> <h2 id="消息中间件作用"><a href="#消息中间件作用" class="header-anchor">#</a> 消息中间件作用</h2> <ul><li>解耦：在项目启动之初来预测将来会碰到什么需求是极其困难的。消息中间件在处理过程中间插入了一个隐含的、基于数据的接口层，两边的处理过程都要实现这一接口，这允许你独立地扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束即可。</li> <li>冗余（存储）：有些情况下，处理数据的过程会失败。消息中间件可以把数据进行持久化直到它们已经被完全处理，通过这一方式规避了数据丢失风险。在把一个消息从消息中间件中删除之前，需要你的处理系统明确地指出该消息已经被处理完成，从而确保你的数据被安全地保存直到你使用完毕。</li> <li>扩展性：因为消息中间件解耦了应用的处理过程，所以提高消息入队和处理的效率是很容易的，只要另外增加处理过程即可，不需要改变代码，也不需要调节参数。</li> <li>削峰：在访问量剧增的情况下，应用仍然需要继续发挥作用，但是这样的突发流量并不常见。如果以能处理这类峰值为标准而投入资源，无疑是巨大的浪费。使用消息中间件能够使关键组件支撑突发访问压力，不会因为突发的超负荷请求而完全崩溃。</li> <li>可恢复性：当系统一部分组件失效时，不会影响到整个系统。消息中间件降低了进程间的耦合度，所以即使一个处理消息的进程挂掉，加入消息中间件中的消息仍然可以在系统恢复后进行处理。
顺序保证：在大多数使用场景下，数据处理的顺序很重要，大部分消息中间件支持一定程度上的顺序性。</li> <li>缓冲：在任何重要的系统中，都会存在需要不同处理时间的元素。消息中间件通过一个缓冲层来帮助任务最高效率地执行，写入消息中间件的处理会尽可能快速。该缓冲层有助于控制和优化数据流经过系统的速度。</li> <li>异步通信：在很多时候应用不想也不需要立即处理消息。消息中间件提供了异步处理机制，允许应用把一些消息放入消息中间件中，但并不立即处理它，在之后需要的时候再慢慢处理。</li></ul> <h2 id="rabbitmq特点"><a href="#rabbitmq特点" class="header-anchor">#</a> RabbitMQ特点</h2> <ul><li>可靠性：RabbitMQ使用一些机制来保证可靠性，如持久化、传输确认及发布确认等。</li> <li>灵活的路由：在消息进入队列之前，通过交换器来路由消息。对于典型的路由功能，RabbitMQ已经提供了一些内置的交换器来实现。针对更复杂的路由功能，可以将多个交换器绑定在一起，也可以通过插件机制来实现自己的交换器。</li></ul> <h2 id="常用消息中间件"><a href="#常用消息中间件" class="header-anchor">#</a> 常用消息中间件</h2> <ul><li><p>ActiveMQ
优点：单机吞吐量万级，时效性 ms 级，可用性高，基于主从架构实现高可用性，较低的概率丢失数据。</p> <p>缺点：官方社区现在对 ActiveMQ 5.x 维护越来越少，高吞吐量场景较少使用。</p></li> <li><p>Kafka
大数据的杀手锏，谈到大数据领域内的消息传输，则绕不开 Kafka，这款为大数据而生的消息中间件，以其百万级 TPS 的吞吐量名声大噪，迅速成为大数据领域的宠儿，在数据采集、传输、存储的过程中发挥着举足轻重的作用。目前已经被 LinkedIn，Uber, Twitter, Netflix 等大公司所采纳。</p> <p>优点：性能卓越，单机写入 TPS 约在百万条 / 秒，最大的优点，就是吞吐量高。时效性 ms 级，可用性非常高，kafka 是分布式的，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用，消费者采用 Pull 方式获取消息，消息有序，通过控制能够保证所有消息被消费且仅被消费一次；有优秀的第三方 Kafka Web 管理界面 Kafka-Manager；在日志领域比较成熟，被多家公司和多个开源项目使用；功能支持：功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用。</p> <p>缺点：Kafka 单机超过 64 个队列 / 分区，Load 会发生明显的飙高现象，队列越多，load 越高，发送消息响应时间变长，使用短轮询方式，实时性取决于轮询间隔时间，消费失败不支持重试；支持消息顺序，但是一台代理宕机后，就会产生消息乱序，社区更新较慢。</p></li> <li><p>RocketMQ
RocketMQ 出自阿里巴巴的开源产品，用 Java 语言实现，在设计时参考了 Kafka，并做出了自己的一 些改进。被阿里巴巴广泛应用在订单，交易，充值，流计算，消息推送，日志流式处理，binglog 分发等场景。</p> <p>优点：单机吞吐量十万级，可用性非常高，分布式架构，消息可以做到 0 丢失，MQ 功能较为完善，还是分布式的，扩展性好，支持 10 亿级别的消息堆积，不会因为堆积导致性能下降。</p> <p>缺点：支持的客户端语言不多，目前是 java 及 c++，其中 c++ 不成熟；社区活跃度一般，没有在 MQ 核心中去实现 JMS 等接口，有些系统要迁移需要修改大量代码。</p></li> <li><p>RabbitMQ
2007 年发布，是一个在 AMQP (高级消息队列协议) 基础上完成的，可复用的企业消息系统，是当前最主流的消息中间件之一。</p> <p>优点：由于 erlang 语言的高并发特性，性能较好；吞吐量到万级，MQ 功能比较完备，健壮、稳定、易用、跨平台、支持多种语言。如：Python、Ruby、.NET、Java、JMS、C、PHP、ActionScript、XMPP、STOMP 等，AJAX 文档齐全；开源提供的管理界面非常棒，用起来很好用，社区活跃度高；更新频率相当高。</p> <p>缺点：商业版需要收费，学习成本较高。</p></li></ul> <p>作者: zhangc233
链接: https://zhangc233.github.io/2021/07/23/RabbitMQ/#MQ-%E7%9A%84%E5%88%86%E7%B1%BB
来源: ZC的学习录</p> <h2 id="rabbitmq入门"><a href="#rabbitmq入门" class="header-anchor">#</a> RabbitMQ入门</h2> <h3 id="介绍"><a href="#介绍" class="header-anchor">#</a> 介绍</h3> <p>RabbitMO整体上是一个生产者与消费者模型，主要负责接收、存储和转发消息。可以把消息传递的过程想象成：当你将一个包裹送到邮局，邮局会暂存并最终将邮件通过邮递员送到收件人的手上，RabbitMQ就好比由邮局、邮箱和邮递员组成的一个系统。从计算机术语层面来说，RabbitMQ模型更像是一种交换机模型。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/RabbitMQ模型架构.png" alt="" loading="lazy"></p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/RabbitMQ工作原理png" alt="RabbitMQ-00000007" loading="lazy"></p> <h3 id="核心概念"><a href="#核心概念" class="header-anchor">#</a> 核心概念</h3> <ul><li>Producer：生产者创建消息，然后发布到RabbitMO中。消息一般可以包含2个部分：<strong>消息体和标签（Label）</strong>。消息体也可以称之为<strong>payload</strong>，在实际应用中，消息体一般是一个带有业务逻辑结构的数据，比如一个JON字符串。当然可以进一步对这个消息体进行序列化操作。消息的标签用来表述这条消息，比如一个交换器的名称和一个路由键。生产者把消息交由RabbitMQ，RabbitMQ之后会根据标签把消息发送给感兴趣的消费者（Consumer）。</li> <li>Consumer：消费者，就是接收消息的一方。消费者连接到RabbitMQ服务器，并订阅到队列上。当消费者消费一条消息时，只是消费消息的消息体（payload）。在消息路由的过程中，<strong>消息的标签会丢弃</strong>，存入到队列中的消息只有消息体，<strong>消费者也只会消费到消息体，也就不知道消息的生产者是谁</strong>，当然消费者也不需要知道。</li> <li>Broker：消息中间件的服务节点。对于RabbitMQ来说，一个RabbitMQ Broker可以简单地看作一个RabbitMQ服务节点，或者RabbitMQ服务实例。大多数情况下也可以将一个RabbitMQ Broker看作一台RabbitMQ服务器。</li></ul> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/消息队列生产消费流程.png" alt="image-20220101153843047" loading="lazy"></p> <ul><li><p>Connection：publisher／consumer 和 broker 之间的 TCP 连接。</p></li> <li><p>Channel：如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 的开销将是巨大的，效率也较低。Channel 是在 connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 thread 创建单独的 channel 进行通讯，AMQP method 包含了 channel id 帮助客户端和 message broker 识别 channel，所以 channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP connection 的开销。</p></li></ul> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/连接和信道.png" alt="image-20220101212952076" loading="lazy"></p> <ul><li><p>Queue：用于存储消息用于存储消息</p></li> <li><p>Exchange：交换器。在图2-中我们暂时可以理解成生产者将消息投递到队列中，实际上这个在RabbitMQ中不会发生。真实情况是，生产者将消息发送到Exchange（交换器，通常也可以用大写的“Ⅹ”来表示），由交换器将消息路由到一个或者多个队列中。如果路由不到，或许会返回给生产者，或许直接丢弃。有四种交换器</p></li> <li><p>RoutingKey：路由键。生产者将消息发给交换器的时候，一般会指定一个RoutingKey，用来指定这个消息的路由规则，而这个Routing Key需要与交换器类型和绑定键（BindingKey）联合使用才能最终生效。在交换器类型和绑定键（BindingKey）固定的情况下，生产者可以在发送消息给交换器时，通过指定RoutingKey来决定消息流向哪里。</p></li> <li><p>Binding：绑定。RabbitMQ中通过绑定将交换器与队列关联起来，在绑定的时候一般会指定一个绑定键BindingKey</p></li></ul> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/绑定.png" alt="image-20220101155411425" loading="lazy"></p> <p>生产者将消息发送给交换器时，需要一个RoutingKey，<strong>当BindingKey和RoutingKey相匹配时，消息会被路由到对应的队列中</strong>。在绑定多个队列到同一个交换器的时候，这些绑定允许使用相同的BindingKey。BindingKey并不是在所有的情况下都生效，它依赖于交换器类型，比如fanout类型的交换器就会无视BindingKey，而是将消息路由到所有绑定到该交换器的队列中。</p> <p>路由键和绑定</p> <ul><li>在使用绑定的时候，其中需要的路由键是BindingKey。涉及的客户端方法如：channel.exchangeBind、channel.queueBind，对应的AMQP命令（详情参见
2.2节）为Exchange.Bind、Queue.Bind。</li> <li>在发送消息的时候，其中需要的路由键是RoutingKey。涉及的客户端方法如
channel.basicPublish，对应的AMQ命令为Basic.Publish。</li></ul> <h3 id="交换器类型-路由规则"><a href="#交换器类型-路由规则" class="header-anchor">#</a> 交换器类型（路由规则）</h3> <ul><li>fanout：它会把所有发送到该交换器的消息路由到所有与该交换器绑定的队列中。</li> <li>direct：它会把消息路由到那些BindingKey和RoutingKey完全匹配的队列中。</li> <li>topic：也是消息路由到绑定和路由相匹配的队列，但不同的是
<ul><li>RoutingKey为一个点号“.”分隔的字符串（被点号“.”分隔开的每一段独立的字符串称为一个单词），如“com.rabbitmq.client'”、“java.util.concurrent”、“com.hidden.client”；</li> <li>BindingKey和RoutingKey一样也是点号“.”分隔的字符串；</li> <li>BindingKey中可以存在两种特殊字符串a星号和“#”，用于做模糊匹配，其中星号用于匹配一个单词，”#“用于匹配多个</li></ul></li> <li>headers：headers类型的交换器不依赖于路由键的匹配规则来路由消息，而是根据发送的消息内容中的headers属性进行匹配。在绑定队列和交换器时制定一组键值对，当发送消息到交换器时，RabbitMQ会获取到该消息的headers（也是一个键值对的形式），对比其中的键值对是否完全匹配队列和交换器绑定时指定的键值对，如果完全匹配则消息会路由到该队列，否则不会路由到该队列。headers类型的交换器性能会很差，而且也不实用，基本上不会看到它的存在。</li></ul> <p>topic举例</p> <ul><li>路由键为“com.rabbitmg.client”的消息会同时路由到Queuel和Queue2；</li> <li>路由键为“com.hidden.client”的消息只会路由到Queue2中；</li> <li>路由键为“com.hidden.demo”的消息只会路由到Queue2中；</li> <li>路由键为“java.rabbitmg.demo”的消息只会路由到Queuel中；</li> <li>路由键为“java.util.concurrent”的消息将会被丢弃或者返回给生产者（需要设置mandatory参数），因为它没有匹配任何路由键。</li></ul> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/topic路由交换器.png" alt="" loading="lazy"></p> <h2 id="客户端开发向导"><a href="#客户端开发向导" class="header-anchor">#</a> 客户端开发向导</h2> <h3 id="连接"><a href="#连接" class="header-anchor">#</a> 连接</h3> <p>指定</p> <ul><li>IP</li> <li>HOST</li> <li>USERNAME</li> <li>PASSWORD</li></ul> <p>创建<strong>Connection</strong>，并创建<strong>Channel</strong>实例，Channel不能在线程间共享会有线程安全问题</p> <p>通过isOpen判断是否处于开启状态</p> <h3 id="使用交换器和队列"><a href="#使用交换器和队列" class="header-anchor">#</a> 使用交换器和队列</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//创建一个type=&quot;direct&quot;非排它非自动删除的交换器</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">&quot;direct&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//创建一个持久化非排它非自动删除的交队列</span>
channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//将交换器与队列通过路由键进行绑定</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ul><li>上面的代码也展示了如何使用路由键将队列和交换器绑定起来。</li> <li>上面声明的队列具备如下特性：只对当前应用中同一个Connection层面<code>可用</code>，同一个Connection的不同Channel可共用，并且也会在应用连接断开时自动删除。</li> <li>如果其他生产消费者声明一样的交换器或队列名字相同时只要属性相同就什么都不做，否则抛出异常</li></ul> <h3 id="交换器声明方法属性"><a href="#交换器声明方法属性" class="header-anchor">#</a> 交换器声明方法属性</h3> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/交换机方法属性_1.png" alt="image-20220101231901431" loading="lazy"></p> <blockquote><p>autoDelete指的是当交换器至少有一个绑定的队列或交换器，且与之解绑时且autoDelete为true时自动删除，而不是与客户端断开连接就删除</p></blockquote> <h3 id="队列申明方法属性"><a href="#队列申明方法属性" class="header-anchor">#</a> 队列申明方法属性</h3> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/队列声明属性.png" alt="image-20220102001031566" loading="lazy"></p> <blockquote><p>生产者和消费者都能够使用queueDeclare来声明一个队列，但是如果消费者在同一个信道上订阅了另一个队列，就无法再声明队列了。必须先取消订阅，然后将信道置为“传输”，才能声明队列</p></blockquote> <h3 id="交换器队列绑定方法属性"><a href="#交换器队列绑定方法属性" class="header-anchor">#</a> 交换器队列绑定方法属性</h3> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/交换器队列绑定方法属性.png" alt="image-20220102002534960" loading="lazy"></p> <h3 id="交换器与交换器绑定"><a href="#交换器与交换器绑定" class="header-anchor">#</a> 交换器与交换器绑定</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;destination&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">exchangeBind</span><span class="token punctuation">(</span><span class="token string">&quot;destination&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;source&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;destination&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;source&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exKey&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;exToExDemo&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>生产者发送消息至交换器source中，交换器source根据路由键找到与其匹配的另一个交换器destination，并把消息转发到destination中，进而存储在destination绑定的队列queue中，可参考图3-1。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/i交换器与交换器绑定.png" alt="image-20220102003824898" loading="lazy"></p> <h3 id="发送消息方法属性"><a href="#发送消息方法属性" class="header-anchor">#</a> 发送消息方法属性</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//发送属性示例</span>
channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token string">&quot;text/plain&quot;</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">deliveryMode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">userId</span><span class="token punctuation">(</span><span class="token string">&quot;hidden&quot;</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">expiration</span><span class="token punctuation">(</span><span class="token string">&quot;6000&quot;</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;message_demo&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/发送消息方法属性.png" alt="image-20220102183618810" loading="lazy"></p> <h3 id="消费消息"><a href="#消费消息" class="header-anchor">#</a> 消费消息</h3> <p>RabbitMQ的消费模式分两种：</p> <ul><li>推（Push）模式：推模式采用Basic.Consume进行消费</li> <li>和拉（Pull）模式：拉模式则是调用Basic.Get进行消费</li></ul> <p>常用一个Channel对应一个消费者</p> <h4 id="推模式-订阅模式"><a href="#推模式-订阅模式" class="header-anchor">#</a> 推模式（订阅模式）</h4> <p>推模式可以通过持续订阅的方式等待消息队列推送消息并消费信息，相关类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">Consumer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>rabbitmg<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">DefaultConsumer</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>接收消息一般通过实现Consumer接口或者继承DefaultConsumer类来实现。当调用与Consumer相关的API方法时，不同的订阅采用不同的消费者标签（consumerTag）来区分彼此，在同一个Channel中的消费者也需要通过唯一的消费者标签以作区分，关键消费代码如代码清单3-9所示。</p> <p>Channel类中的basicConsume方法有如下形式</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/消费消息推模式方法属性.png" alt="image-20220102200123744" loading="lazy"></p> <h4 id="拉模式-主动消费"><a href="#拉模式-主动消费" class="header-anchor">#</a> 拉模式（主动消费）</h4> <p>这里讲一下拉模式的消费方式。通过channel.basicGet方法可以单条地获取消息，其返回值是GetRespone。Channel类的basicGet方法没有其他重载方法，只有：
GetResponse basicGet (String queue,boolean autoAck)throws IOException;其中queue代表队列的名称，如果设置autoAck为false，那么同样需要调用channel.basicAck来确认消息已被成功接收。拉模式的关键代码如代码清单3-10所示。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">GetResponse</span> response <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">basicGet</span><span class="token punctuation">(</span>QUEUE<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置autoAck为false需要basicAck来确认消息接收成功</span>
channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><blockquote><p>Basic.Consume将信道（Channel）置为接收模式即推模式，直到取消队列的订阅为止。在接收模式期间，RabbitMQ会不断地推送消息给消费者，当然推送消息的个数还是会受到Basic.Qos的限制。如果只想从队列获得单条消息而不是持续订阅，建议还是使用Basic.Get进行消费。但是不能将Basic.Get放在一个循环里来代替Basic.Consume，这样做会严重影响RabbitMQ的性能。如果要实现高吞吐量，消费者理应使用Basic.Consume方法。</p></blockquote> <h3 id="消费者端确认与拒绝autoack"><a href="#消费者端确认与拒绝autoack" class="header-anchor">#</a> 消费者端确认与拒绝autoAck</h3> <p>为了保证消息从队列可靠地达到消费者，RabbitMQ提供了消息确认机制（messageacknowledgement）。消费者在订阅队列时，可以指定autoAck参数，</p> <ul><li>当autoAck等于false时，RabbitMQ会等待消费者显式地回复确认信号后才从内存（或者磁盘）中移去消息、（实质上是先打上删除标记，之后再删除）。</li> <li>当autoAck等于true时，RabbitMQ会自动把发送出去的消息置为确认，然后从内存（或者磁盘）中删除，而不管消费者是否真正地消费到了这些消息。</li></ul> <p>采用消息确认机制后，只要设置autoAck参数为false，消费者就有足够的时间处理消息（任务），不用担心处理消息过程中消费者进程挂掉后消息丢失的问题，因为RabbitMQ会一直等待持有消息直到消费者显式调用Basic.Ack命令为止。</p> <p>当autoAck参数置为false，对于RabbitMQ服务端而言，队列中的消息分成了两个部分：</p> <ul><li><p>一部分是等待投递给消费者的消息</p></li> <li><p>一部分是已经投递给消费者</p></li></ul> <p>但是还没有收到消费者确认信号的消息。如果RabbitMQ一直没有收到消费者的确认信号，并且消费此消息的消费者已经断开连接，则RabbitMQ会安排该消息重新进入队列，等待投递给下一个消费者，当然也有可能还是原来的那个消费者。且RabbitMQ不会为其设置过期时间</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/查看ready.png" alt="image-20220102212838391" loading="lazy"></p> <h4 id="消息拒绝"><a href="#消息拒绝" class="header-anchor">#</a> 消息拒绝</h4> <p>RabbitMQ在2.O.0版本开始引入了Basic.Reject这个命令，消费者客户端可以调用与其对应的channel.basicReject方法来告诉RabbitMQ拒绝这个消息。</p> <p>Channel类中的basicReject方法定义如下：void basicReject (long deliveryTag,boolean requeue)throws IOException;</p> <p>其中deliveryTag可以看作消息的编号，它是一个64位的长整型值，最大值是9223372036854775807。</p> <ul><li>如果requeue参数设置true，则RabbitMQ会重新将这条消息存入队列，以便可以发送给下一个订阅的消费者；</li> <li>如果requeue参数设置为false，则RabbitMQ立即会把消息从队列中移除，而不会把它发送给新的消费者。</li></ul> <p>Basic.Reject命令一次只能拒绝一条消息，如果想要批量拒绝消息，则可以使用</p> <p>Basic.Nack这个命令。消费者客户端可以调用channel.basicNack方法来实现，方法定义如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> basicNack <span class="token punctuation">(</span><span class="token keyword">long</span> deliveryTag<span class="token punctuation">,</span><span class="token keyword">boolean</span> multiple<span class="token punctuation">,</span><span class="token keyword">boolean</span> requeue<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其中 deliverytag和 requeue的含义可以参考 basicreject方法。</p> <ul><li>multiple参数设置为 false则表示拒绝编号为 deliverytag的这一条消息，这时候 basicnack和basicreject方法一样；</li> <li>multiple参数设置为tue则表示拒绝 deliverytag编号之前所有未被当前消费者确认的消息。</li></ul> <h4 id="消息恢复"><a href="#消息恢复" class="header-anchor">#</a> 消息恢复</h4> <p>这个 channel. basicrecover方法用来请求 Rabbitmq重新发送还未被确认的消息。如果 requeue参数设置为true，则未被确认的消息会被重新加入到队列中，这样对于同一条消息来说，可能会被分配给与之前不同的消费者。如果 requeue参数设置为 false，那么同一条消息会被分配给与之前相同的消费者。默认情况下，如果不设置 requeue这个参数，相当于channe. basicrecover（true），即 requeue默认为tue</p> <h3 id="关闭连接"><a href="#关闭连接" class="header-anchor">#</a> 关闭连接</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//conn关闭channel也会关闭</span>
conn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>连接和信道状态</p> <ul><li>Open：开启状态，代表当前对象可以使用。</li> <li>Closing：正在关闭状态。当前对象被显式地通知调用关闭方法（ shutdown），这样就产生了一个关闭请求让其内部对象进行相应的操作，并等待这些关闭操作的完成。</li> <li>Closed：已经关闭状态。当前对象已经接收到所有的内部对象已完成关闭动作的通知，并且其也关闭了自身。</li></ul> <p>同时还有对应的其他方法</p> <h2 id="消息何去何从-未路由消息处理"><a href="#消息何去何从-未路由消息处理" class="header-anchor">#</a> 消息何去何从（未路由消息处理）</h2> <h3 id="mandatory-immediate"><a href="#mandatory-immediate" class="header-anchor">#</a> mandatory&amp;immediate</h3> <p>mandatory和 immediate是 <code>channel.basicpublish</code>方法中的两个参数，它们都有当消息传递过程中不可达目的地时将消息返回给生产者的功能。</p> <p>概括来说：</p> <ul><li>mandatory：参数告诉服务器至少将该消息路由到一个队列中，否则将消息返回给生产者。</li> <li>immediate：参数告诉服务器，如果该消息关联的队列上有消费者，则立刻投递如果所有匹配的队列上都没有消费者，则直接将消息返还给生产者，不用将消息存入队列而等待消费者了。</li></ul> <p>Rabbitmq提供的备份交换器（ Alternate Exchange）可以将未能被交换器路由的消息（没有绑定队列或者没有匹配的绑定）存储起来，而不用返回给客户端</p> <h3 id="mandatory"><a href="#mandatory" class="header-anchor">#</a> mandatory</h3> <ul><li>true：交换器无法根据自身类型和路由键找到符合的队列，那么 Rabbitmq会调用 Basic.Return命令将消息返回给生产者</li> <li>false：当 mandatory参数设置为 false时，出现上述情形，则消息直接被丢弃。</li></ul> <p>拿回返回来的消息可以用<code>channel.addReturnListener</code>添加<code>ReturnListener</code>监听器来实现</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">mandatory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//- true：交换器无法根据自身类型和路由键找到符合的队列，那么 Rabbitmq会调用 Basic.Return命令将消息返回给生产者</span>
  <span class="token comment">//- false：当 mandatory参数设置为 false时，出现上述情形，则消息直接被丢弃。</span>
  channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> <span class="token string">&quot;54343&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token string">&quot;mandatory_msg&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">addReturnListener</span><span class="token punctuation">(</span><span class="token punctuation">(</span>replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Basic.Return返回的结果是 ：&quot;</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/mandatory参数.png" alt="image-20220103131152641" loading="lazy"></p> <h3 id="immediate"><a href="#immediate" class="header-anchor">#</a> immediate</h3> <p>已不支持，影响镜像队列性能，建议采用TTL和DLX方法替代</p> <h3 id="备份交换机"><a href="#备份交换机" class="header-anchor">#</a> 备份交换机</h3> <p>生产者在发送消息的时候如果不设置 mandatory参数，那么消息在未被路由的情况下将会丢失；如果设置了 mandatory参数，那么需要添加 Returnlistener的编程逻辑，生产者的代码将变得复杂。</p> <p>如果既不想复杂化生产者的编程逻辑，又不想消息丢失，那么可以使用备份交换器，这样可以将未被路由的消息存储在 Rabbitmq中，再在需要的时候去处理这些消息。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">alternateExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;alternate-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alternate_exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;alternate_exchange&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;normal_queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;normal_queue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;normal_exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;normal_key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;unRoute_queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;unRoute_queue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;alternate_exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>声明了两个交换机normal和alternate，分别绑定队列normal和unroute，同时将alternate设置为normal的备份交换机。如果发送消息到Normal上未路由到正确队列，则会发送给备用交换机的队列。为了方便使用备份交换机设置为<code>fanout</code>类型</p> <blockquote><p>消息被重新您发送到备份时的<code>路由键</code>和从生产者发出的路由键一样，如果设置备份交换机为direct且没有路由到队列消息也会丢失</p></blockquote> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/备份交换机.png" alt="image-20220103141226407" loading="lazy"></p> <p>可能的情况</p> <ul><li><p>如果设置的备份交换器不存在，客户端和 Rabbitmq服务端都不会有异常出现，此时消息会丢失。</p></li> <li><p>如果备份交换器没有绑定任何队列，客户端和 Rabbitmq服务端都不会有异常出现，此时消息会丢失。</p></li> <li><p>如果备份交换器没有任何匹配的队列，客户端和 Rabbitmq服务端都不会有异常出现，此时消息会丢失。</p></li> <li><p>如果备份交换器和<code>mandatory</code>参数一起使用，那么mandatory参数<code>无效</code>。</p></li></ul> <h2 id="过期时间-ttl"><a href="#过期时间-ttl" class="header-anchor">#</a> 过期时间(TTL)</h2> <p>RabbitMQ可以对消息和队列设置TTL。</p> <ul><li>消息的过期：指限定时间内没有被消费</li> <li>队列的过期：指删除前除于未使用状态的时间</li></ul> <h3 id="设置消息ttl"><a href="#设置消息ttl" class="header-anchor">#</a> 设置消息TTL</h3> <p>目前有两种方法可以设置消息的TTL。</p> <ul><li>第一种方法是通过队列属性设置，队列中所有消息都有相同的过期时间。</li> <li>第二种方法是对消息本身进行单独设置，每条消息的TTL可以不同。</li></ul> <p>如果两种方法一起使用，则消息的TTL以<code>两者之间较小的那个数值为准</code>。消息在队列中的生存时间一旦超过设置的TTL值时，就会变成<code>死信（ Dead Message）</code>，消费者将无法再收到该消息（这点不是绝对的，可以参考4.3节）。</p> <p>设置方法一：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">timeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//1.声明队列过期</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>还可以通过Policy和HTTP API接口设置。</p> <ul><li>如果不设置TTL，则表示此消息不会过期；</li> <li>如果将TTL设置为0，则表示除非此时可以直接将消息投递到消费者，否则该消息会被立即丢弃，这个特性可以部分替代 Rabbitmq3.0版本之前的 immediate参数，之所以部分代替，是因为 immediate参数在投递失败时会用Basic. Return将消息返回（这个功能可以用死信队列来实现，详细参考4.3节）。</li></ul> <p>设置方法二：</p> <p>针对每条消息设置TTL的方法是在 channel. basicpublish方法中加入 expiration的属性参数，单位为毫秒。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;ttl_queue&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">deliveryMode</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">expiration</span><span class="token punctuation">(</span><span class="token string">&quot;6000&quot;</span><span class="token punctuation">)</span>
                     <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MSG<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>判定时机的区别：</p> <ul><li>对于第一种设置队列TL属性的方法，一旦消息过期，就会从队列中抹去</li> <li>而在第二种方法中，即使消息过期，也不会马上从队列中抹去，因为考虑到可能各个消息TTL不同需要扫描整个队列，所以在即将投递到消费者之前判定是否过期然后抹掉</li></ul> <p>区别原因：</p> <ul><li>因为第一种方法里，队列中己过期的消息肯定在队列头部， Rabbitmq只要定期从队头开始扫描是否有过期的消息即可。</li> <li>而第二种方法里，每条消息的过期时间不同，如果要删除所有过期消息势必要扫描整个队列，所以不如等到此消息即将被消费时再判定是否过期，如果过期再进行删除即可即懒加载</li></ul> <h3 id="设置队列ttl"><a href="#设置队列ttl" class="header-anchor">#</a> 设置队列TTL</h3> <p>通过声明队列时的参数<code>x-expires</code>参数可以控制队列被自动删除前处于<code>未使用状态</code>的时间。未使用的意思是：</p> <ul><li>队列上没有任何的消费者</li> <li>队列也没有被重新声明</li> <li>在过期时间段内也未调用过 Basic.Get命令</li></ul> <p>设置队列里的TTL可以应用于类似RPC方式的回复队列，在RPC中，许多队列会被创建出来，但是却是未被使用的。</p> <p>Rabbitmq会确保在过期时间到达后将队列删除，但是不保障删除的动作有多及时。在Rabbitmq重启后，持久化的队列的过期时间会被重新计算。</p> <p>用于表示过期时间的x- expires参数以毫秒为单位，并且服从和x- message-ttl一样的约束条件，不过不能设置为0。比如该参数设置为1000，则表示该队列如果在1秒钟之内未使用则会被删除</p> <h2 id="死信队列"><a href="#死信队列" class="header-anchor">#</a> 死信队列</h2> <p>DLX，全称为 Dead-letter-Exchange，可以称之为死信交换器，也有人称之为死信邮箱。当消息在一个队列中变成死信（ dead message）之后，它能被重新被发送到另一个交换器中，这个交换器就是DLX，绑定DLX的队列就称之为死信队列。</p> <h3 id="消息成为死信的情况"><a href="#消息成为死信的情况" class="header-anchor">#</a> 消息成为死信的情况</h3> <ul><li>消息被拒绝（ Basic.Reject/ Basic.Nack）并且设置 requeue参数为 false</li> <li>消息过期</li> <li>队列达到最大长度。</li></ul> <p>DLX也是一个正常的交换器，和一般的交换器没有区别，它能在任何的队列上被指定，实际上就是设置某个队列的属性。当这个队列中存在死信时， Rabbitmq就会自动地将这个消息重新发布到设置的DLX上去，进而被路由到另一个队列，即死信队列。</p> <p>可以监听这个队列中的消息以进行相应的处理，这个特性与将消息的TTL设置为0配合使用可以弥补 <code>immediate</code>参数的功能。</p> <p>通过在 <code>channe.queuedeclare</code>方法中设置<code>x-dead-letter-exchange</code>参数来为这个队列添加DLX（代码清单4-7中的d1_exchange）</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dlx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//声明死信交换器</span>
  channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;dlx_exchange&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dlx_exchange&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//死信交换器的路由，不指定则用生产者发送消息是的路由</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;dlx_routing_key&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//给队列添加DLX</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;dlx_queue&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: ttl和dlx示例,消息过期后会被发送到死信交换器绑定的死信队列
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ttlAndDlx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//声明死信交换器</span>
  channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;exchange.dlx&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>DIRECT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//声明普通交换机</span>
  channel<span class="token punctuation">.</span><span class="token function">exchangeDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;exchange.normal&quot;</span><span class="token punctuation">,</span> <span class="token class-name">BuiltinExchangeType</span><span class="token punctuation">.</span>FANOUT<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-message-ttl&quot;</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-exchange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exchange.dlx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-dead-letter-routing-key&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;routingKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;queue.normal&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;queue.normal&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exchange.normal&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;queue.dlx&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueBind</span><span class="token punctuation">(</span><span class="token string">&quot;queue.dlx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;exchange.dlx&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;routingKey&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;exchange.normal&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token string">&quot;dlx_1&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/死信队列.png" alt="image-20220103211442199" loading="lazy"></p> <p>对于 Rabbitmq来说，DLX是一个非常有用的特性。它可以处理异常情况下，消息不能够被消费者正确消费（消费者调用了 Basic.Nack或者 Basic. Reject）而被置入死信队列中的情况，后续分析程序可以通过消费这个死信队列中的内容来分析当时所遇到的异常情况，进而可以改善和优化系统。DLX配合TTL使用还可以实现延迟队列的功能，详细请看下一节。</p> <h2 id="延迟队列"><a href="#延迟队列" class="header-anchor">#</a> 延迟队列</h2> <p>延迟队列存储的对象是对应的延迟消息，所谓“延迟消息”是指当消息被发送以后，并不想让消费者立刻拿到消息，而是等待特定时间后，消费者才能拿到这个消息进行消费。延迟队列的使用场景有很多，比如：</p> <ul><li>在订单系统中，一个用户下单之后通常有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行异常处理，这时就可以使用延迟队列来处理这些订单了。</li> <li>用户希望通过手机远程遥控家里的智能设备在指定的时间进行工作。这时候就可以将用户指令发送到延迟队列，当指令设定的时间到了再将指令推送到智能设备。</li></ul> <p>在AMQP中本身不支持延迟队列，但是可以通过DLX和TTL模拟延迟队列，即消费者订阅死信队列，然后生产者发送消息指定TTL到TTL后消息就能进入死信队列，消费者刚好能消费这个延迟了TTL的消息</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/image-20220108184812049.png" alt="image-20220108184812049" loading="lazy"></p> <h2 id="优先级队列"><a href="#优先级队列" class="header-anchor">#</a> 优先级队列</h2> <p>指队列和消息的优先级，优先级高的消息具备优先被消费的特权</p> <ul><li>消息队列优先级：可以通过<code>x-max-priority</code>设置</li> <li>消息优先级：通过prop参数设置，默认最低优先级0，最高位队列设置的最大优先级，优先级高可以被优先消费，这里的优先级比较是队列中的值而不包括准备发送的消息</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: 优先级队列
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">priorityQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token class-name">Maps</span><span class="token punctuation">.</span><span class="token function">newHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//声明优先级</span>
  args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;x-max-priority&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token string">&quot;queue.priority&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//设置消息优先级</span>
  channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
                       <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token comment">//默认最小是0</span>
                       <span class="token punctuation">.</span><span class="token function">priority</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;message&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/优先级队列.png" alt="image-20220108233051589" loading="lazy"></p> <h2 id="rpc实现"><a href="#rpc实现" class="header-anchor">#</a> RPC实现</h2> <p>一般在RabbitMQ中进行RPC是很简单。客户端发送请求消息，服务端回复响应的消息。</p> <p>为了接收响应的消息，我们需要在请求消息中发送一个回调队列（参考下面代码中的<code>replyTo</code>）。可以使用默认的队列，具体示例代码如代码清单4-11所示。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: rpc调用且回调
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">rpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> callbackQueueName <span class="token operator">=</span> channel<span class="token punctuation">.</span><span class="token function">queueDeclare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;rpc_queue&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">AMQP<span class="token punctuation">.</span>BasicProperties<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                       <span class="token comment">//回调队列接收响应的消息</span>
                       <span class="token punctuation">.</span><span class="token function">replyTo</span><span class="token punctuation">(</span>callbackQueueName<span class="token punctuation">)</span>
                       <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token string">&quot;message&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>对于代码中涉及的BasicProperties这个类，这里就用到两个属性。</p> <ul><li>replyTo：通常用来设置一个回调队列。</li> <li>correlationId：用来关联请求（request）和其调用RPC之后的回复（response）。</li></ul> <p>如果像上面的代码中一样，为每个RPC请求创建一个回调队列，则是非常低效的。但是幸运的是这里有一个通用的解决方案——<strong>可以为每个客户端创建一个单一的回调队列</strong>。这样就产生了一个新的问题，对于回调队列而言，在其接收到一条回复的消息之后，它并不知道这条消息应该和哪一个请求匹配。</p> <p>这里就用到<code>correlationId</code>这个属性了，我们应该为每一个请求设置一个唯一的<code>correlationId</code>。之后在回调队列接收到回复的消息时，可以根据这个属性匹配到相应的请求。如果回调队列接收到一条未知<code>correlationId</code>的回复消息，可以简单地将其丢弃。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/rabbitmq-rpc.png" alt="image-20220109180122979" loading="lazy"></p> <p>RPC处理流程如下：</p> <ul><li>当客户端启动时，创建一个匿名的回调队列（名称由RabbitMQ自动创建）。</li> <li>客户端为RPC请求设置2个属性：replyTo用来告知RPC服务端回复请求时的目的队列，即回调队列；correlationId用来标记一个请求。</li> <li>请求被发送到rpc queue队列中。</li> <li>RPC服务端监听rpc_queue队列中的请求，当请求到来时，服务端会处理并且把带有结果的消息发送给客户端。接收的队列就是replyTo设定的回调队列。</li> <li>客户端监听回调队列，当有消息时，检查correlationId属性，如果与请求匹配，那就是结果了。</li></ul> <h2 id="持久化"><a href="#持久化" class="header-anchor">#</a> 持久化</h2> <ul><li>交换机持久化：声明时设置<code>durable</code>参数为true，不设置持久化重启关闭时消息不会丢失，但是相关的交换器元数据会丢失，不能将消息发送到这个交换器了</li> <li>队列持久化：声明时设置<code>durable</code>参数为true，不设置持久化重启关闭时消息会丢失</li> <li>消息持久化：投递时将消息的<code>deliveryMode</code>属性设置为2即可持久化，如果只是队列持久化当重启后消息会丢失，如果消息持久化但是队列没持久化name消息也会丢失</li></ul> <blockquote><p>可以将所有的消息都设置为持久化，但是这样会严重影响RabbitMO的<code>性能</code>（随机）。写入磁盘的速度比写入内存的速度慢得不只一点点。对于可靠性不是那么高的消息可以不采用持久化处理以提高整体的吞吐量。在选择是否要将消息持久化时，需要在可靠性和吐吞量之间做一个权衡</p></blockquote> <p>如果都设置持久化并不意味着数据不会丢失，当订阅消息队列时设置<code>autoAck</code>为true时消费者这边没及时消费那么就会丢失消息</p> <h3 id="镜像队列"><a href="#镜像队列" class="header-anchor">#</a> 镜像队列</h3> <p>其次，在持久化的消息正确存入RabbitMQ之后，还需要有一段时间（虽然很短，但是不可忽视）才能存入磁盘之中。RabbitMQ并不会为每条消息都进行同步存盘（调用内核的fsync方法）的处理，可能仅仅保存到<code>操作系统缓存</code>之中而不是物理磁盘之中。如果在这段时间内RabbitMQ服务节点发生了宕机、重启等异常情况，消息保存还没来得及落盘，那么这些消息将丢失。</p> <p>RabbitMQ的镜像队列机制相当于配置了副本主节点和从节点，实际生产环境的关键业务业务队列也会设置镜像队列，还可以在发送端引入<code>事务机制</code>或者<code>发送方确认机制</code>来保证消息已经正确地发送并存储至RabbitMQ中，前提还要保证在调用<code>channel.basicPublish</code>方法的时候交换器能够将消息正确路由到相应的队列之中。</p> <h2 id="生产者确认"><a href="#生产者确认" class="header-anchor">#</a> 生产者确认</h2> <p>除了消费者确认应答机制，还要确保生产者这边到底有没有正确把消息发送到<code>消息队列的交换器</code>中去，默认情况生产者发送消息服务器不会返回任何消息给生产者，有以下方式</p> <ul><li>通过事务机制</li> <li>通过发送方确认机制</li></ul> <blockquote><ul><li>两者不能共存</li> <li>这里的确认消息发送到RabbitMQ是指消息被正确的发往RabbitMQ的交换器，如果交换器没有匹配的队列消息也可能会丢失，配合mandory参数或备份交换器使用</li></ul></blockquote> <h3 id="事务机制"><a href="#事务机制" class="header-anchor">#</a> 事务机制</h3> <p>相关的方法有三个</p> <ul><li>channel.txSelect：将当前信道设置成事务模式</li> <li>channel.txCommit：用于提交事务</li> <li>channel.txRollback：用于事务回滚</li></ul> <p>在通过channel.txSelect方法开启事务之后，我们便可以发布消息给RabbitMQ了：</p> <ul><li>如果事务提交成功，则消息一定到达了RabbitMQ中</li> <li>如果在事务提交执行之前由于RabbitMQ异常崩溃或者其他原因抛出异常，这个时候我们便可以将其捕获，进而通过执行channel.txRollback方法来实现事务回滚。</li></ul> <blockquote><p>注意这里的RabbitMQ中的事务机制与大多数数据库中的事务概念并不相同，需要注意区分。</p> <p>事务机制在一条消息发送后会使发送端阻塞，以等待Rabbitmq回应，之后才能发送下一条消息</p></blockquote> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: 事务
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将信道设置为事务模式</span>
  channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token string">&quot;transaction&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//提交事务</span>
  channel<span class="token punctuation">.</span><span class="token function">txCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>流程如下</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/rabbitmq事务.png" alt="image-20220110154800172" loading="lazy"></p> <ul><li>客户端发送Tx.Select，将信道置为事务模式：</li> <li>Broker回复Tx.Select-Ok，确认已将信道置为事务模式；</li> <li>在发送完消息之后，客户端发送Tx.Commit提交事务；</li> <li>Broker回复Tx.Commit-Ok，确认事务提交。</li></ul> <h4 id="事务回滚"><a href="#事务回滚" class="header-anchor">#</a> 事务回滚</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: 事务
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//将信道设置为事务模式</span>
  channel<span class="token punctuation">.</span><span class="token function">txSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">,</span> <span class="token class-name">MessageProperties</span><span class="token punctuation">.</span>PERSISTENT_TEXT_PLAIN<span class="token punctuation">,</span> <span class="token string">&quot;transaction&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//异常</span>
      <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">//提交事务</span>
      channel<span class="token punctuation">.</span><span class="token function">txCommit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//在事务提交之前铺捉到异常并回滚</span>
      channel<span class="token punctuation">.</span><span class="token function">txRollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/事务回滚.png" alt="image-20220110160010989" loading="lazy"></p> <h3 id="发送确认机制"><a href="#发送确认机制" class="header-anchor">#</a> 发送确认机制</h3> <p>使用事务机制会使RabbitMQ性能有损失造成吞吐量下降，所以有发送确认机制。</p> <p>生产者将信道设置成<code>confirm（确认）模式</code>，一旦信道进入confirm模式，所有在该信道上面发布的消息都会被指派一个唯一的ID（从1开始），一旦消息被投递到所有匹配的队列之后，RabbitMQ就会发送一个确认（Basic.Ack）给生产者（包含消息的唯一ID），这就使得生产者知晓消息已经正确到达了目的地了。</p> <blockquote><p>如果消息和队列是可持久化的，那么确认消息会在消息写入磁盘之后发出。</p></blockquote> <p>RabbitMQ回传给生产者的确认消息中的<code>deliveryTag</code>包含了确认消息，此外RabbitMQ也可以设置channel.basicAck方法中的<code>multiple</code>参数，表示到这个序号之前的所有消息都已经得到了处理，可以参考图4-10。注意辨别这里的确认和消费时候的确认之间的异同。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/发送方确认机制.png" alt="image-20220110171845530" loading="lazy"></p> <p>事务机制在一条消息发送之后会使发送端阻塞，以等待RabbitMQ的回应，之后才能继续发送下一条消息。</p> <p>相比之下，发送方确认机制最大的好处在于它是<code>异步</code>的，一旦发布一条消息，生产者应用程序就可以在等信道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用程序便可以通过<code>回调方法</code>来处理该确认消息，如果RabbitMQ因为自身内部错误导致消息丢失，就会发送一条<code>nack（Basic.Nack）</code>命令，生产者应用程序同样可以在回调方法中处理该nack命令。</p> <h4 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h4> <ul><li>生产者通过调用<code>channel.confirmSelect</code>方法（即Confirm.Select命令）将信道设置为<code>confirm</code>模式</li> <li>之后RabbitMQ会返回Confirm.Select-Ok命令表示同意生产者将当前信道设置为confirm模式。</li> <li>所有被发送的后续消息都被ack或者nack一次，不会出现一条消息既被ack又被nack的情况，并且RabbitMQ也并没有对消息被confirm的快慢做任何保证。</li></ul> <p>确认方式</p> <ul><li>单个同步确认：每发送一个消息就调用<code>channel.waitForConfirms</code>，这时候是同步串行化的</li> <li>批量确认：每发送一批消息后，再调用<code>channel.waitForConfirms</code>方法，等待服务器确认返回。当出现Nack或超时情况，客户端需要将这一批次消息重发，带来明显的重复消息数量，且经常消息丢失时，批量confirm性能不升反降</li> <li>异步确认：提供回调方法，服务端确认了一条或者多条消息后客户端会回调方法处理</li></ul> <p>单个同步确认&amp;批量确认：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: 发送者确认：发送确认机制(单个同步确认，批量确认)
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//设置为确认模式</span>
  channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//单个同步确认</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token string">&quot;producer confirm&quot;</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//服务端返回 false 或超时时间内未返回，生产者可以消息重发</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">//批量确认</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token string">&quot;producer confirm&quot;</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息批量发送成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息批量发送失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//重新批量发送消息</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/发送多条消息发送确认模式.png" alt="image-20220110181136940" loading="lazy"></p> <p>异步确认：</p> <p>异步confirm方法的编程实现最为复杂。在客户端Channel接口中提供的<code>addConfirmListener</code>方法可以添加<code>ConfirmListener</code>这个回调接口，这个ConfirmListener接口包含两个方法：<code>handleAck</code>和<code>handleNack</code>，分别用来处理
RabbitMQ回传的<code>Basic.Ack</code>和<code>Basic.Nack</code>。在这两个方法中都包含有一个参数<code>deliveryTag</code>（在publisher confirm模式下用来标记消息的唯一有序序号）。我们需要为每一个信道维护一个已发送未确认的消息序号集合，</p> <ul><li>在发送时根据channel.getNextPublishSeqNo()获取发送消息时的<code>deliveryTag</code>并插入</li> <li>在回调方法中根据返回的<code>deliveryTag</code>去移除集合中的消息或标记其已确认</li></ul> <p>集合最好采用<code>SortedSet</code>维护消息序号，<code>waitForConfirms</code>也是通过<code>Sortedset</code>来维护消息序号</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * @description: 发送者确认：发送确认机制(异步确认)
     **/</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">confirmAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
  <span class="token class-name">Channel</span> channel <span class="token operator">=</span> <span class="token class-name">RabbitMqUtils</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">queuePurge</span><span class="token punctuation">(</span>QUEUE_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  channel<span class="token punctuation">.</span><span class="token function">confirmSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/*
         * 线程安全跳跃表
         * 1.map能将序号与消息进行关联
         * 2.轻松批量删除条目根据序号
         * 3.线程安全并发
         * */</span>
  <span class="token comment">//已发送未确认的消息</span>
  <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> outstandingConfirm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentSkipListMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 消息确认成功，回调函数</span>
  <span class="token class-name">ConfirmCallback</span> ackCallback <span class="token operator">=</span> <span class="token punctuation">(</span>deliverTag<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是批量的,就批量清除</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>multiple<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      outstandingConfirm<span class="token punctuation">.</span><span class="token function">headMap</span><span class="token punctuation">(</span>deliverTag<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      outstandingConfirm<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>deliverTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;消息确认成功：&quot;</span> <span class="token operator">+</span> deliverTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">/*
         * 1. 消息的标记
         * 2. 是否为批量确认
         * */</span>
  <span class="token class-name">ConfirmCallback</span> nackCallback <span class="token operator">=</span> <span class="token punctuation">(</span>deliverTag<span class="token punctuation">,</span> multiple<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> outstandingConfirm<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>deliverTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;未确认的消息：&quot;</span> <span class="token operator">+</span> deliverTag<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/*
         * 消息监听器
         * 1. 监听那些成功了
         * 2. 监听那些失败了
         * */</span>
  channel<span class="token punctuation">.</span><span class="token function">addConfirmListener</span><span class="token punctuation">(</span>ackCallback<span class="token punctuation">,</span> nackCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    outstandingConfirm<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">getNextPublishSeqNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicPublish</span><span class="token punctuation">(</span>EXCHANGE_NAME<span class="token punctuation">,</span> ROUTING_KEY<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;发布&quot;</span> <span class="token operator">+</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token string">&quot;个异步确认消息&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h4 id="watiforconfirm"><a href="#watiforconfirm" class="header-anchor">#</a> watiForConfirm</h4> <p>如果没有开启confirm模式调用任何watiForConfirm都会报错。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * Wait until all messages published since the last call have been
 * either ack'd or nack'd by the broker.  Note, when called on a
 * non-Confirm channel, waitForConfirms throws an IllegalStateException.
 * @return whether all the messages were ack'd (and none were nack'd)
 * @throws java.lang.IllegalStateException
 */</span>
<span class="token keyword">boolean</span> <span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Wait until all messages published since the last call have been
 * either ack'd or nack'd by the broker; or until timeout elapses.
 * If the timeout expires a TimeoutException is thrown.  When
 * called on a non-Confirm channel, waitForConfirms throws an
 * IllegalStateException.
 * @return whether all the messages were ack'd (and none were nack'd)
 * @throws java.lang.IllegalStateException
 */</span>
<span class="token keyword">boolean</span> <span class="token function">waitForConfirms</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>

<span class="token comment">/** Wait until all messages published since the last call have
 * been either ack'd or nack'd by the broker.  If any of the
 * messages were nack'd, waitForConfirmsOrDie will throw an
 * IOException.  When called on a non-Confirm channel, it will
 * throw an IllegalStateException.
 * @throws java.lang.IllegalStateException
 */</span>
 <span class="token keyword">void</span> <span class="token function">waitForConfirmsOrDie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">;</span>

<span class="token comment">/** Wait until all messages published since the last call have
 * been either ack'd or nack'd by the broker; or until timeout elapses.
 * If the timeout expires a TimeoutException is thrown.  If any of the
 * messages were nack'd, waitForConfirmsOrDie will throw an
 * IOException.  When called on a non-Confirm channel, it will
 * throw an IllegalStateException.
 * @throws java.lang.IllegalStateException
 */</span>
<span class="token keyword">void</span> <span class="token function">waitForConfirmsOrDie</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p><code>waitForConfirmsOrDie</code>在接收到RabbitMQ返回的Basic.Nack之后会抛出<code>IoException</code>异常</p> <h3 id="比较"><a href="#比较" class="header-anchor">#</a> 比较</h3> <p>四种方式比较</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/生产者确认四种方式QPS比较.png" alt="image-20220110223704926" loading="lazy"></p> <p>可以看到批量confirm和异步confirm这两种方式所呈现的性能要比其余两种好得多。</p> <p>事务机制和普通confirm的方式吐吞量很低，但是编程方式简单，不需要在客户端维护状态（这里指的是维护deliveryTag及缓存未确认的消息）</p> <p>批量confirm方式的问题在于遇到RabbitMQ服务端返回Basic.Nack需要重发批量消息而导致的性能降低。异步confirm方式编程模型最为复杂，而且和批量confirm方式一样需要在客户端维护状态。</p> <p>在实际生产环境中采用何种方式，这里就仁者见仁智者见智了，不过<strong>强烈建议读者使用异步confirm的方式</strong>。</p> <h2 id="消费端要点"><a href="#消费端要点" class="header-anchor">#</a> 消费端要点</h2> <p>对于消费者有几点要注意</p> <ul><li>消息分发</li> <li>消息顺序性</li> <li>弃用QueueingConsumer</li></ul> <h3 id="消息分发"><a href="#消息分发" class="header-anchor">#</a> 消息分发</h3> <p>当RabbitMQ队列拥有多个消费者时，队列收到的消息将以<code>轮询（round-robin）</code>的分发方式发送给消费者。每条消息只会发送给订阅列表里的一个消费者。这种方式非常适合扩展，而且它是专门为并发程序设计的。如果现在负载加重，那么只需要创建更多的消费者来消费处理消息即可。</p> <p>轮询的方式在消费者处理性能方面不能做到好的均衡，有些消费者处理慢有些处理快造成整体吞吐量下降，可以用到<code>channel.basicQos(int prefetchCount)</code>这个方法，<strong>允许限制信道上的消费者所能保持的最大未确认消息数量</strong>。</p> <p>举例说明，在订阅消费队列之前，消费端程序调用了<code>channel.basicQos(5)</code>，之后订阅了某个队列进行消费。RabbitMO会保存一个消费者的列表，每发送一条消息都会为对应的消费者计数，如果达到了所设定的上限，那么RabbitMQ就不会向这个消费者再发送任何消息。直到消费者确认了某条消息之后，RabbitMQ将相应的计数减l，之后消费者可以继续接收消息，直到再次到达计数上限。这种机制可以类比于TCP/IP中的“滑动窗口”。</p> <blockquote><p>basicQos对于拉模式无效</p> <p>basicQos设置为0则无上限</p></blockquote> <p>channel.basicQos方法</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/basicQos.png" alt="image-20220114140010010" loading="lazy"></p> <p>参数</p> <ul><li><p>prefetchCount：允许限制信道上的消费者所能保持的最大未确认消息数量，设置为0无上限</p></li> <li><p>prefetchCount：消息本身大小限制，设置为0无上限</p></li> <li><p>grobal：</p> <p>对于一个信道来说，它可以同时消费多个队列，当设置了<code>prefetchCount</code>大于0时，这个信道需要和各个队列协调以确保发送的消息都没有超过所限定的prefetchCount的值，这样会使RabbitMQ的性能降低，尤其是这些队列分散在集群中的多个Broker节点之中。RabbitMQ为了提升相关的性能，在AMQP0-9-1协议之上重新定义了global这个参数，对比如表4-1所示。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/grobal参数对比.png" alt="image-20220114141718769" loading="lazy"></p></li></ul> <blockquote><p>global为true时是对整个信道的未确认数量总和做限制和共享</p></blockquote> <p>示例</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/多个global.png" alt="image-20220114150921343" loading="lazy"></p> <p>那么这里每个消费者最多只能收到<code>3个</code>未确认的消息，两个消费者能收到的未确认的消息个数之和的上限为<code>5个</code>。在未确认消息的情况下，如果consumerl接收到了消息、1、2和3，那么consumer2至多只能收到11和12.如果像这样同时使用两种global的模式，则会增加RabbitMQ的负载，因为RabbitMQ需要更多的资源来协调完成这些限制。</p> <p>如无特殊需要，最好只使用global为false的设置，这也是默认的设置。</p> <h3 id="消息顺序性"><a href="#消息顺序性" class="header-anchor">#</a> 消息顺序性</h3> <p>指消费者消费到的消息和发送者发布的消息顺序一致。</p> <p>理想情况下消息是顺序性的，下面一些情况RabbitMQ的顺序性会被打破：</p> <ul><li>生产者使用<code>事务机制</code>或<code>确认模式</code>，发送消息后遇到异常进行消息补偿发送，此时需要重新补偿发送消息，补偿消息是另一个线程实现此时顺序就会打乱</li> <li>生产者设置不同的消息TTL且设置死信队列，此时消费者消息死信队列的消费顺序和生产者发送消息的顺序不一致</li> <li>生产者设置不同的消息优先级</li> <li>多个消费者消费时，有消费者拒绝且设置requeue为true，此时其他消费者会消费这个被拒绝重新入队的消息</li></ul> <p>解决办法</p> <p>需要业务方使用RabbitMQ做进一步处理，比如在消息体内添加全局有序标识符(类似Sequence ID)</p> <h3 id="弃用queueingconsumer"><a href="#弃用queueingconsumer" class="header-anchor">#</a> 弃用QueueingConsumer</h3> <p>内存溢出问题，底层使用的是<code>LinkedBlockingQueue</code>，通过设置BasicQos来解决，除此之外还有其他缺陷：</p> <ul><li>QueueingConsumer会拖累同一个Connection下的所有信道，使其性能降低；</li> <li>同步递归调用QueueingConsumer会产生死锁；</li> <li>RabbitMQ的自动连接恢复机制（automatic connection recovery）不支持QueueingConsumer的这种形式；</li> <li>QueueingConsumer不是事件驱动的。</li></ul> <p>为了避免不必要的麻烦，建议在消费的时候尽量使用继承DefaultConsumer的方式，</p> <h2 id="消息传输保障"><a href="#消息传输保障" class="header-anchor">#</a> 消息传输保障</h2> <p>消息传输保障分为三个层级</p> <ul><li>At most once：最多一次。消息可能会丢失，但绝不会重复传输。</li> <li>At least once：最少一次。消息绝不会丢失，但可能会重复传输。</li> <li>Exactly once：恰好一次。每条消息肯定会被传输一次且仅传输一次。</li></ul> <p>RabbitMQ支持最多一次和最少一次，投递要考虑以下几个方面内容去保障消息</p> <ul><li>生产者要开启事务机制或者生产者确认机制，确保消息可靠地传输到RabbitMQ中</li> <li>生产者需要配合使用mandatory参数或者备份交换器来确保消息能够从交换器路由到队列中，进而保存下来不被丢弃</li> <li>消息和队列都要持久化处理，以确保RabbitMQ服务器在遇到异常情况时不会消息丢失</li> <li>消费者在消费消息的同时需要将<code>autoAck</code>设置为<code>false</code>，然后通过手动确认的方式去确认已经正确消费的消息，避免在消费端消息丢失</li></ul> <h3 id="恰好一次"><a href="#恰好一次" class="header-anchor">#</a> 恰好一次</h3> <p>RabbitMQ无法保障恰好一次，有两种情况重复消费情况</p> <ul><li>消费者这边发送Basic.Ack的这时候网络断开，此时RabbitMQ没有收到命令且断开后就会重新将消息入队，此时这条消息就会被<code>重复消费</code></li> <li>生产者使用生产者确认机制时，此时网络断开，生产者做异常处理重新发送消息，此时RabbitMQ就会有两个一样的消息，造成<code>重复消费</code></li></ul> <p>目前主流消息中间件没有去重机制，去重处理一般在客户端实现，比如<code>GUID</code>，可能需要借助集中式缓存去存储然后去重</p> <h2 id="rabbitmq管理"><a href="#rabbitmq管理" class="header-anchor">#</a> RabbitMQ管理</h2> <h3 id="多用户和权限"><a href="#多用户和权限" class="header-anchor">#</a> 多用户和权限</h3> <p>每一个RabbitMO服务器都能创建虚拟的消息服务器，我们称之为虚拟主机（virtual host），简称为vhost.</p> <p>每一个vhost本质上是一个独立的小型RabbitMQ服务器，拥有自己独立的队列、交换器及绑定关系等，并且它拥有自己独立的权限。vhost就像是虚拟机与物理服务器一样，它们在各个实例间提供逻辑上的分离，为不同程序安全保密地运行数据，它既能将同一个RabbitMQ中的众多客户区分开，又可以避免队列和交换器等命名冲突。</p> <p>vhost之间是<code>绝对隔离</code>的，无法将vhostl1中的交换器与vhost2中的队列进行绑定，这样既保证了安全性，又可以确保可移植性</p> <p>如果在使用RabbitMQ达到一定规模的时候，建议用户对业务功能、场景进行归类区分，并为之分配独立的vhost。</p> <p>vhost是AMQP概念的基础，客户端在连接的时候必须制定一个vhost。RabbitMQ默认创建的vhost为<code>“/”</code>，如果不需要多个vhost或者对vhost的概念不是很理解，那么用这个默认的vhost也是非常合理的，使用默认的用户名guest和密码guest就可以访问它。但是为了安全和方便，建议重新建立一个新的用户来访问它。</p> <p>vhost有关命令</p> <p>创建vhost</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//创建vhost
rabbitmqctl add_vhost vhost1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查询vhost</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//tracing是否使用了trace功能
rabbitmqctl list_vhost <span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token punctuation">[</span>tracing<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>删除vhost</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl delete_bhost <span class="token punctuation">[</span>name<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>vhost权限</p> <p>AMQP协议中并没有指定权限在vhost级别还是在服务器级别实现，由具体的应用自定义。在RabbitMQ中，权限控制则是<code>以vhost为单位</code>的。当创建一个用户时，用户通常会被指派给至少一个vhost，并且只能访问被指派的vhost内的队列、交换器和绑定关系等。因此，RabbitMQ中的授予权限是指在vhost级别对用户而言的权限授予。</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/rabbitmq授予权限命令.png" alt="image-20220114213316862" loading="lazy"></p> <blockquote><ul><li>可配置：指的是队列和交换器的创建及删除之类的操作；</li> <li>可写：指的是发布消息；</li> <li>可读：指与消息有关的操作，包括读取消息及清空整个队列等。</li></ul></blockquote> <p>AMQP命令与权限的映射关系</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/AMQP命令与权限的映射关系.png" alt="image-20220114213500746" loading="lazy"></p> <p>vhost权限分配示例</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//授予root用户可访问虚拟主机vhostl，并在所有资源上都具备可配置、可写及可读的权限
rabbitmqctl set_permissions -p vhost1 root <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>

//授予root用户可访问虚拟主机vhost2，在以“queue”开头的资源上具备可配置权限，并在所有资源上拥有可写、可读的权限
rabbitmqctl set_permissions -p vhost2 root <span class="token string">&quot;^queue.*&quot;</span> <span class="token string">&quot;.*&quot;</span> <span class="token string">&quot;.*&quot;</span>

//清除权限
rabbitmqctl clear_permissions -p vhost2 root

//列举vhost的相关用户权限
rabbitmqctl list_permissions -p vhost1
  Listing permissions <span class="token keyword">for</span> vhost <span class="token string">&quot;vhost1&quot;</span> <span class="token punctuation">..</span>.
  user	configure	<span class="token function">write</span>	<span class="token builtin class-name">read</span>
  root	.*	.*	.*

//列举用户的权限
rabbitmqctl list_user_permissions root
  Listing permissions <span class="token keyword">for</span> user <span class="token string">&quot;root&quot;</span> <span class="token punctuation">..</span>.
  vhost	configure	<span class="token function">write</span>	<span class="token builtin class-name">read</span>
  /	.*	.*	.*
  vhost1	.*	.*	.*
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h3 id="用户管理"><a href="#用户管理" class="header-anchor">#</a> 用户管理</h3> <p>罗列用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl list_users
  Listing <span class="token function">users</span> <span class="token punctuation">..</span>.
  user	tags
  guest	<span class="token punctuation">[</span>administrator<span class="token punctuation">]</span>
  root	<span class="token punctuation">[</span>administrator<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl add_user <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token punctuation">{</span>password<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>设置角色</p> <ul><li>none：无任何角色，默认角色</li> <li>management：可以访问web管理界面</li> <li>policymaker：包含management权限，并且可管理策略policy和参数</li> <li>monitoring：包含management权限，并且可以看到所有连接，信道以及节点</li> <li>administrator：包含management权限，并且可以管理用户，虚拟主机，权限，策略，参数等，最高权限</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code>rabbitmqctl set_user_tags {username} {tag...}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>改密码</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl change_password <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token punctuation">{</span>password<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>用户验证</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl authenticate_user <span class="token punctuation">{</span>username<span class="token punctuation">}</span> <span class="token punctuation">{</span>password<span class="token punctuation">}</span>
  Authenticating user <span class="token string">&quot;root1&quot;</span> <span class="token punctuation">..</span>.
  Success
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>删除用户</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>rabbitmqctl delete_user
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="web端管理"><a href="#web端管理" class="header-anchor">#</a> Web端管理</h3> <h2 id="应用与集群"><a href="#应用与集群" class="header-anchor">#</a> 应用与集群</h2> <h3 id="应用"><a href="#应用" class="header-anchor">#</a> 应用</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//停止运行rabbitMQ的Erlang虚拟机和RabbitMQ服务应用,如果指定pid文件还需要等待指定进程结束
rabbitmqctl stop <span class="token punctuation">{</span>pid.file<span class="token punctuation">}</span>

//停止运行rabbitMQ的Erlang虚拟机和RabbitMQ服务应用
rabbitmqctl <span class="token function">shutdown</span>

//停止RabbitMQ应用但是Erlang虚拟机还是运行状态。一般用于管理操作前停止RabbitMQ
rabbitmqctl stop_app

//启动RabbitMQ应用
rabbitmqctl start_app

//等待RabbitMQ应用启动，会等到pid_file创建且pid_file中的进程启动
rabbitmqctl <span class="token function">wait</span> <span class="token punctuation">{</span>pid_file<span class="token punctuation">}</span>

//将RabbitMQ节点重置还原到最初状态，包括用户，vhost，所有数据等
rabbitmqctl reset/force_reset
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h3 id="集群"><a href="#集群" class="header-anchor">#</a> 集群</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>//将节点加入到指定集群
rabbitmqctl join_cluster <span class="token punctuation">{</span>cluster_node<span class="token punctuation">}</span>

//集群状态
rabbitmqctl cluster_status

//修改集群节点类型,这个命令前需要停止RabbitMQ应用
rabbitmqctl change_cluster_node_type <span class="token punctuation">{</span>disc<span class="token operator">|</span>ram<span class="token punctuation">}</span>

//将节点从集群中删除,允许离线执行
rabbitmqctl forget_cluster_node <span class="token punctuation">[</span>--offline<span class="token punctuation">]</span>

//在集群的节点应用启动前咨询clusternode节点的最新消息，并更新相应的集群消息
rabbitmqctl update_cluster_nodes <span class="token punctuation">{</span>clusternode<span class="token punctuation">}</span>

//确保节点可以启动，通常集群关闭时再启动的第一个节点是最后关闭的节点
//在特殊情况下所有节点都认为自己是最后一个节点，使用该命令告诉节点可以无条件启动节点
rabbitmqctl force_boot

//指示未同步队列queue的slave镜像可以同步master镜像行的内容，前提是queue配置了镜像
//未同步队列中的消息被耗尽后，也会变成同步，主要用于为耗尽队列
rabbitmqctl sync_queue <span class="token punctuation">[</span>-p vhost<span class="token punctuation">]</span> <span class="token punctuation">{</span>queue<span class="token punctuation">}</span>

//取消队列同步镜像
rabbitmqctl cancel_sync_queue <span class="token punctuation">[</span>-p vhost<span class="token punctuation">]</span> <span class="token punctuation">{</span>queue<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><h3 id="服务端状态"><a href="#服务端状态" class="header-anchor">#</a> 服务端状态</h3> <h4 id="队列查询"><a href="#队列查询" class="header-anchor">#</a> 队列查询</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>//没指定vhost则默认为/，queueInfoItem显示的属性
rabbitmqctl list_queues [-p vhost] [queueInfoItem]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>显示属性示例</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/queue显示属性1.png" alt="image-20220115214336053" loading="lazy"></p> <h4 id="交换器"><a href="#交换器" class="header-anchor">#</a> 交换器</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>rabbitmqctl list_exchanges [-p vhost] [exchangeInfoItem]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可选显示参数</p> <p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/交换器可显示参数.png" alt="image-20220115214725834" loading="lazy"></p> <h4 id="绑定"><a href="#绑定" class="header-anchor">#</a> 绑定</h4> <div class="language- line-numbers-mode"><pre class="language-text"><code>rabbitmqctl list_bindings [-p vhost] [bindingInfoItem]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://blog-1300186248.cos.ap-shanghai.myqcloud.com/RabbitMQ/绑定可选显示参数.png" alt="image-20220115215014713" loading="lazy"></p> <h4 id="连接-2"><a href="#连接-2" class="header-anchor">#</a> 连接</h4> <p>获取TCP/IP连接信息</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>rabbitmqctl list_connections [-p vhost] [connectionInfoItem]
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其他更多参考官方文档</p> <h3 id="httpapi管理"><a href="#httpapi管理" class="header-anchor">#</a> HTTPAPI管理</h3> <p>接口列表可以在web管理界面的左下角的HTTP API</p> <p><a href="http://localhost:15672/api/index.html" target="_blank" rel="noopener noreferrer">http://localhost:15672/api/index.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>如果单纯使用curl方式可以用<code>rabbitmqadmin</code>工具来调用，是一个python脚本，该工具只是一种用于访问 rabbitmq-server api 便捷方式</p> <ul><li><a href="https://www.rabbitmq.com/management-cli.html" target="_blank" rel="noopener noreferrer">官方文档参考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://soft.dog/2016/04/20/RabbitMQ-cli-rabbitmqadmin/" target="_blank" rel="noopener noreferrer">rabbitmqadmin使用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <p>工具下载方式：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">curl</span> http://localhost:15672/cli/rabbitmqadmin
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="rabbitmq配置"><a href="#rabbitmq配置" class="header-anchor">#</a> RabbitMQ配置</h2> <p>大多数情况不用修改配置，提供了三种方式定制化：</p> <ul><li>环境变量（Enviroment Variables）。RabbitMQ服务端参数可以通过环境变量进行配置，例如，节点名称、RabbitMQ配置文件的地址、节点内部通信端口等。</li> <li>配置文件（Configuration File）。可以定义RabbitMQ服务和插件设置，例如，TCP监听端口，以及其他网络相关的设置、内存限制、磁盘限制等。</li> <li>运行时参数和策略（Runtime Parameters and Policies）。可以在运行时定义集群层面的服务设置。</li></ul> <h3 id="环境变量"><a href="#环境变量" class="header-anchor">#</a> 环境变量</h3> <p>在Shell环境中配置，环境变量都是以<code>RABBITMQ_</code>开头，也可以在<code>rabbitmq-env.conf</code>中配置</p> <p>非Shell环境中配置，则需要去除<code>RABBITMQ_</code>前缀</p> <p>优先级：Shell环境 &gt; 配置文件 &gt; 默认配置</p> <p>当采用rabbitmq-server-detached启动RabbitMQ服务的时候，此服务节点默认以“rabbit@”加上当前的Shell环境的hostname（主机名）来命名，即rabbit@$HOSTNAME。如果要自定义名称可以在<code>rabbitmq-server</code>命令前添加<code>RABBITMQ_NODENAME</code></p></div> <!----> <div class="content__content-bottom"></div> <footer class="page-meta"><div class="edit-link"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon edit-icon"><path d="M117.953 696.992 64.306 959.696l265.931-49.336 450.204-452.505-212.284-213.376-450.204 452.513zm496.384-296.326L219.039 797.993l-46.108-46.34L568.233 354.33l46.104 46.335zm345.357-122.99-114.45 115.04-212.288-213.377 114.45-115.035 212.288 213.371zm0 0" fill="currentColor"></path></svg> <a href="https://github.com/LifeAlsoIsGG/edit/main/mq/rabbitmq/RabbitMQ.md" target="_blank" rel="noopener noreferrer">Edit this page</a></div> <div class="meta-item update-time"><span class="label">Last update:</span> <span class="info">June 13, 2022 02:47</span></div> <div class="meta-item contributors"><span class="label">Contributors: </span> <span class="info"><span title="email: 52524117+LifeIsAlsoGG@users.noreply.github.com" class="contributor">
          Draco
        </span> <!----></span></div></footer> <!----> <div class="comments-wrapper"><div class="waline-wrapper"><div id="waline-comment"></div></div></div> <!----> <div class="content__page-bottom"></div></main> <footer class="footer-wrapper"><div class="media-links-wrapper"><a href="https://github.com/LifeAlsoIsGG" rel="noopener noreferrer" target="_blank" aria-label="Github" data-balloon-pos="up" class="media-link"><span class="sr-only">Github</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-github"><circle cx="512" cy="512" r="512" fill="#171515"></circle> <path d="M509.423 146.442c-200.317 0-362.756 162.42-362.756 362.8 0 160.266 103.936 296.24 248.109 344.217 18.139 3.327 24.76-7.872 24.76-17.486 0-8.613-.313-31.427-.49-61.702-100.912 21.923-122.205-48.63-122.205-48.63-16.495-41.91-40.28-53.067-40.28-53.067-32.937-22.51 2.492-22.053 2.492-22.053 36.407 2.566 55.568 37.386 55.568 37.386 32.362 55.438 84.907 39.43 105.58 30.143 3.296-23.444 12.667-39.43 23.032-48.498-80.557-9.156-165.246-40.28-165.246-179.297 0-39.604 14.135-71.988 37.342-97.348-3.731-9.178-16.18-46.063 3.556-96.009 0 0 30.46-9.754 99.76 37.19 28.937-8.048 59.97-12.071 90.823-12.211 30.807.14 61.843 4.165 90.822 12.21 69.26-46.944 99.663-37.189 99.663-37.189 19.792 49.946 7.34 86.831 3.61 96.01 23.25 25.359 37.29 57.742 37.29 97.347 0 139.366-84.82 170.033-165.637 179.013 13.026 11.2 24.628 33.342 24.628 67.182 0 48.498-.445 87.627-.445 99.521 0 9.702 6.535 20.988 24.945 17.444 144.03-48.067 247.881-183.95 247.881-344.175 0-200.378-162.442-362.798-362.802-362.798z" fill="#FFF"></path></svg></a><a href="https://twitter.com/LifeAlsoIsGG" rel="noopener noreferrer" target="_blank" aria-label="Twitter" data-balloon-pos="up" class="media-link"><span class="sr-only">Twitter</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-twitter"><circle cx="512" cy="512" r="512" fill="#5EAADE"></circle> <path d="M749.737 364.631c-17.594 7.805-36.513 13.088-56.371 15.459 20.269-12.148 35.836-31.387 43.156-54.312A196.233 196.233 0 0 1 674.2 349.6c-17.894-19.083-43.406-30.997-71.636-30.997-54.2 0-98.137 43.944-98.137 98.157 0 7.695.861 15.19 2.544 22.373-81.57-4.092-153.876-43.174-202.284-102.558-8.443 14.498-13.285 31.356-13.285 49.348 0 34.05 17.326 64.096 43.656 81.697a97.69 97.69 0 0 1-44.447-12.277c-.01.41-.01.82-.01 1.24 0 47.558 33.822 87.23 78.72 96.249a98.285 98.285 0 0 1-25.852 3.448 97.491 97.491 0 0 1-18.465-1.768c12.483 39.002 48.725 67.38 91.672 68.17-33.582 26.334-75.897 42.024-121.884 42.024-7.924 0-15.736-.46-23.408-1.37 43.434 27.844 95.014 44.104 150.443 44.104 180.505 0 279.221-149.576 279.221-279.294 0-4.263-.09-8.494-.278-12.708 19.178-13.835 35.813-31.115 48.967-50.807z" fill="#FFF"></path></svg></a><a href="http://localhost:8083/blog-vuepress/tencent:/AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=1138312802.html" rel="noopener noreferrer" target="_blank" aria-label="QQ" data-balloon-pos="up" class="media-link"><span class="sr-only">QQ</span> <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon icon-qq"><circle cx="512" cy="512" r="512" fill="#5EAADE"></circle> <path d="M729.46 627.3c-3.157-39.628-24.045-83.747-32.624-105.91l-22.084-57.047c-.702-23.73 6.312-78.322-30.511-146.61s-110.82-74.446-124.497-75.147c-13.677-.701-99.248-1.403-141.331 72.945-42.084 74.347-30.745 148.812-30.745 148.812l-23.523 57.478c-.001.002-10.962 26.223-20.43 58.135-9.469 31.914-18.938 82.064-9.469 92.234 9.47 10.17 43.837-46.643 46.993-51.903 0 0 2.456 27.18 8.943 41.383l.81 1.776.33.723.38.826.3.652.444.96.203.436a281.465 281.465 0 0 0 1.917 4.025l.189.386c.231.473.468.953.711 1.442l.146.292c6.886 13.807 18.61 33.823 37.443 50.42l.018.016-1.184.387c-10.667 3.516-31.694 11.21-40.625 19.82-1.717 1.655-2.987 3.344-3.65 5.045-5.376 13.794 4.208 15.43 20.575 16.366 16.366.934 94.923 3.04 132.564-2.221.407-.056.787-.114 1.17-.171 2.711.094 5.324.142 7.83.16l.151.002c.836.005 1.663.008 2.475.008.496 0 1.015-.002 1.542-.006l.21-.001a222.593 222.593 0 0 0 5.462-.107c.26.038.508.076.778.114 37.642 5.26 116.198 3.156 132.564 2.22 16.366-.934 25.951-2.571 20.574-16.365-4.302-11.037-34.175-21.62-45.956-25.413a141.388 141.388 0 0 0 7.958-7.645l.237-.245a142.494 142.494 0 0 0 2.53-2.702c42.435-46.643 38.928-76.101 40.682-92.935 0 0 35.775 51.553 43.488 53.306 7.713 1.754 10.169-6.31 7.012-45.94z" fill="#FFF"></path></svg></a></div> <div class="footer">粤ICP备19126168号</div> <div class="copyright">Copyright © 2022 Draco</div></footer></div><div class="global-ui"><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><!----><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close" aria-label="Close" class="pswp__button pswp__button--close"></button> <button title="Share" aria-label="Share" class="pswp__button pswp__button--share"></button> <button title="Switch to full screen" aria-label="Switch to full screen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" aria-label="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Prev (Arrow Left)" aria-label="Prev (Arrow Left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (Arrow Right)" aria-label="Next (Arrow Right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/assets/js/app.daa8f6a5.js" defer></script><script src="/assets/js/vendors~layout-Layout.df1685e0.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.9dd70d26.js" defer></script><script src="/assets/js/page-RabbitMQ.50dfe249.js" defer></script><script src="/assets/js/vendors~layout-Blog~layout-Layout.2ab8e312.js" defer></script>
  </body>
</html>
